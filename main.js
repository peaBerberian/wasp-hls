(()=>{function W(r){throw new Error("Unreachable path taken")}function g(){}var Te=0,F=class extends h{constructor(){super();this.error=g,this.warn=g,this.info=g,this.debug=g,this._currentLevel=Te}setLevel(t){let n=t<0||t>4?0:t;this._currentLevel=n,this.error=n>=1?console.error.bind(console):g,this.warn=n>=2?console.warn.bind(console):g,this.info=n>=3?console.info.bind(console):g,this.debug=n>=4?console.debug.bind(console):g,this.trigger("onLogLevelChange",n)}getLevel(){return this._currentLevel}hasLevel(t){return t>=this._currentLevel}},Pe=new F,o=Pe;var h=class{constructor(){this._listeners={}}addEventListener(e,t){let n=this._listeners[e];Array.isArray(n)?n.push(t):this._listeners[e]=[t]}removeEventListener(e,t){if(e===void 0){this._listeners={};return}let n=this._listeners[e];if(!Array.isArray(n))return;if(t===void 0){delete this._listeners[e];return}let a=n.indexOf(t);a!==-1&&n.splice(a,1),n.length===0&&delete this._listeners[e]}trigger(e,t){let n=this._listeners[e];!Array.isArray(n)||n.slice().forEach(a=>{try{a(t)}catch(i){o.error("EventEmitter: listener error",i instanceof Error?i:null)}})}};function H(){let r="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(r+="0",e=0),r+String(e)}}var xe=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});xe.decode();var $e=new Uint8Array;var D=new TextEncoder("utf-8"),Ye=typeof D.encodeInto=="function"?function(r,e){return D.encodeInto(r,e)}:function(r,e){let t=D.encode(r);return e.set(t),{read:r.length,written:t.length}};var Ke=new Int32Array;var Xe=new Float64Array;var Je=new Uint32Array;var p=Object.freeze({Init:0,0:"Init",RegularInterval:1,1:"RegularInterval",Seeking:2,2:"Seeking",Seeked:3,3:"Seeked",LoadedData:4,4:"LoadedData",LoadedMetadata:5,5:"LoadedMetadata",CanPlay:6,6:"CanPlay",CanPlayThrough:7,7:"CanPlayThrough",Ended:8,8:"Ended",Pause:9,9:"Pause",Play:10,10:"Play",RateChange:11,11:"RateChange",Stalled:12,12:"Stalled"}),Ze=Object.freeze({MultivariantPlaylist:0,0:"MultivariantPlaylist",MediaPlaylist:1,1:"MediaPlaylist"}),L=Object.freeze({NoSupportedVariant:0,0:"NoSupportedVariant",UnfoundLockedVariant:1,1:"UnfoundLockedVariant",MediaSourceAttachmentError:2,2:"MediaSourceAttachmentError",Unknown:3,3:"Unknown"}),S=Object.freeze({AlreadyCreatedWithSameType:0,0:"AlreadyCreatedWithSameType",CantPlayType:1,1:"CantPlayType",EmptyMimeType:2,2:"EmptyMimeType",MediaSourceIsClosed:3,3:"MediaSourceIsClosed",NoMediaSourceAttached:4,4:"NoMediaSourceAttached",QuotaExceededError:5,5:"QuotaExceededError",Unknown:6,6:"Unknown"}),_=Object.freeze({Timeout:0,0:"Timeout",Status:1,1:"Status",Error:2,2:"Error",Other:3,3:"Other"}),er=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),rr=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),tr=Object.freeze({UnknownError:0,0:"UnknownError",NoContentLoaded:1,1:"NoContentLoaded"}),nr=Object.freeze({SourceBufferNotFound:0,0:"SourceBufferNotFound",UnknownError:1,1:"UnknownError"}),ar=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),or=Object.freeze({MissingExtM3uHeader:0,0:"MissingExtM3uHeader",MultivariantPlaylistWithoutVariant:1,1:"MultivariantPlaylistWithoutVariant",MissingUriLineAfterVariant:2,2:"MissingUriLineAfterVariant",UnableToReadVariantUri:3,3:"UnableToReadVariantUri",VariantMissingBandwidth:4,4:"VariantMissingBandwidth",InvalidValue:5,5:"InvalidValue",MediaTagMissingType:6,6:"MediaTagMissingType",MediaTagMissingName:7,7:"MediaTagMissingName",MediaTagMissingGroupId:8,8:"MediaTagMissingGroupId",UnableToReadLine:9,9:"UnableToReadLine",Unknown:10,10:"Unknown"}),O=Object.freeze({UnparsableExtInf:0,0:"UnparsableExtInf",UriMissingInMap:1,1:"UriMissingInMap",MissingTargetDuration:2,2:"MissingTargetDuration",UriWithoutExtInf:3,3:"UriWithoutExtInf",UnparsableByteRange:4,4:"UnparsableByteRange",Unknown:5,5:"Unknown"}),ir=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",MediaSourceIsClosed:1,1:"MediaSourceIsClosed",QuotaExceededError:2,2:"QuotaExceededError",TypeNotSupportedError:3,3:"TypeNotSupportedError",EmptyMimeType:4,4:"EmptyMimeType",UnknownError:5,5:"UnknownError"}),C=Object.freeze({NoResource:0,0:"NoResource",NoSourceBuffer:1,1:"NoSourceBuffer",TransmuxerError:2,2:"TransmuxerError",UnknownError:3,3:"UnknownError"}),Q=Object.freeze({BufferFull:0,0:"BufferFull",UnknownError:1,1:"UnknownError"}),sr=Object.freeze({Init:0,0:"Init",Seeked:1,1:"Seeked",Seeking:2,2:"Seeking",Ended:3,3:"Ended",ReadyStateChanged:4,4:"ReadyStateChanged",RegularInterval:5,5:"RegularInterval",Error:6,6:"Error"}),ur=Object.freeze({MediaPlaylistRefresh:0,0:"MediaPlaylistRefresh",RetryRequest:1,1:"RetryRequest"}),dr=Object.freeze({Error:0,0:"Error",Warn:1,1:"Warn",Info:2,2:"Info",Debug:3,3:"Debug"}),U=Object.freeze({Audio:0,0:"Audio",Video:1,1:"Video"}),R=Object.freeze({Closed:0,0:"Closed",Ended:1,1:"Ended",Open:2,2:"Open"});var We={bufferGoal:15,segmentRequestTimeout:2e4,segmentBackoffBase:300,segmentBackoffMax:2e3,multiVariantPlaylistRequestTimeout:15e3,multiVariantPlaylistBackoffBase:300,multiVariantPlaylistBackoffMax:2e3,mediaPlaylistRequestTimeout:15e3,mediaPlaylistBackoffBase:300,mediaPlaylistBackoffMax:2e3},$=We;var c={AlreadyInitializedError:"AlreadyInitializedError",WasmRequestError:"WasmRequestError",UnknownInitializationError:"UnknownInitializationError",SegmentBadHttpStatus:"SegmentBadHttpStatus",SegmentRequestTimeout:"SegmentRequestTimeout",SegmentRequestError:"SegmentRequestError",SegmentRequestOtherError:"SegmentRequestOtherError",MultivariantPlaylistBadHttpStatus:"MultivariantPlaylistBadHttpStatus",MultivariantPlaylistRequestTimeout:"MultivariantPlaylistRequestTimeout",MultivariantPlaylistRequestError:"MultivariantPlaylistRequestError",MultivariantPlaylistRequestOtherError:"MultivariantPlaylistRequestOtherError",MediaPlaylistBadHttpStatus:"MediaPlaylistBadHttpStatus",MediaPlaylistRequestTimeout:"MediaPlaylistRequestTimeout",MediaPlaylistRequestError:"MediaPlaylistRequestError",MediaPlaylistRequestOtherError:"MediaPlaylistRequestOtherError",MediaSourceAttachmentError:"MediaSourceAttachmentError",NoSupportedVariant:"NoSupportedVariant",UnfoundLockedVariant:"UnfoundLockedVariant",Unknown:"Unknown",SourceBufferCantPlayType:"SourceBufferCantPlayType",SourceBufferCreationOtherError:"SourceBufferCreationOtherError",MultivariantPlaylistMissingExtM3uHeader:"MultivariantPlaylistMissingExtM3uHeader",MultivariantPlaylistWithoutVariant:"MultivariantPlaylistWithoutVariant",MultivariantPlaylistMissingUriLineAfterVariant:"MultivariantPlaylistMissingUriLineAfterVariant",MultivariantPlaylistVariantMissingBandwidth:"MultivariantPlaylistVariantMissingBandwidth",MultivariantPlaylistInvalidValue:"MultivariantPlaylistInvalidValue",MultivariantPlaylistMediaTagMissingType:"MultivariantPlaylistMediaTagMissingType",MultivariantPlaylistMediaTagMissingName:"MultivariantPlaylistMediaTagMissingName",MultivariantPlaylistMediaTagMissingGroupId:"MultivariantPlaylistMediaTagMissingGroupId",MultivariantPlaylistOtherParsingError:"MultivariantPlaylistOtherParsingError",MediaPlaylistUnparsableExtInf:"MediaPlaylistUnparsableExtInf",MediaPlaylistUriMissingInMap:"MediaPlaylistUriMissingInMap",MediaPlaylistMissingTargetDuration:"MediaPlaylistMissingTargetDuration",MediaPlaylistUriWithoutExtInf:"MediaPlaylistUriWithoutExtInf",MediaPlaylistUnparsableByteRange:"MediaPlaylistUnparsableByteRange",MediaPlaylistOtherParsingError:"MediaPlaylistOtherParsingError",SegmentTransmuxingError:"SegmentTransmuxingError",SegmentParsingOtherError:"SegmentParsingOtherError",SourceBufferFullError:"SourceBufferFullError",SourceBufferAppendError:"SourceBufferAppendError",SourceBufferRemoveError:"SourceBufferRemoveError",SourceBufferOtherError:"SourceBufferOtherError"};var y=class extends Error{constructor(t,n,a){super();switch(Object.setPrototypeOf(this,y.prototype),this.name="WaspInitializationError",t){case 0:this.code=c.AlreadyInitializedError;break;case 1:this.code=c.WasmRequestError;break;case 2:this.code=c.UnknownInitializationError;break}this.globalCode=this.code,this.wasmHttpStatus=n,this.message=a}};var k=class extends Error{constructor(t,n,a){super();switch(Object.setPrototypeOf(this,k.prototype),this.name="WaspMediaPlaylistParsingError",n){case O.MissingTargetDuration:this.code="MediaPlaylistMissingTargetDuration";break;case O.UnparsableByteRange:this.code="MediaPlaylistUnparsableByteRange";break;case O.UnparsableExtInf:this.code="MediaPlaylistUnparsableExtInf";break;case O.UriMissingInMap:this.code="MediaPlaylistUriMissingInMap";break;case O.UriWithoutExtInf:this.code="MediaPlaylistUriWithoutExtInf";break;case O.Unknown:this.code="MediaPlaylistOtherParsingError";break;default:this.code="MediaPlaylistOtherParsingError";break}this.globalCode=this.code,this.mediaType=t,this.message=a??"Unknown error when parsing a Media Playlist"}};var E=class extends Error{constructor(t,n,a,i,s){super();Object.setPrototypeOf(this,E.prototype),this.name="WaspMediaPlaylistRequestError",this.mediaType=i,this.url=t;let u=s;switch(n){case _.Status:u=u??(a===void 0?"A Media Playlist HTTP(S) request(s) responded with an invalid status":`A Media Playlist HTTP(S) request(s) responded with a ${a} status`),this.code=c.MediaPlaylistBadHttpStatus;break;case _.Timeout:u=u??"A Media Playlist HTTP(S) request(s) did not respond",this.code=c.MediaPlaylistRequestTimeout;break;case _.Error:u=u??"A Media Playlist HTTP(S) request(s) failed due to an error.",this.code=c.MediaPlaylistRequestError;break;case _.Other:u=u??"A Media Playlist HTTP(S) request(s) failed for an unknown reason.",this.code=c.MediaPlaylistRequestOtherError;break;default:this.code=c.MediaPlaylistRequestOtherError;break}this.globalCode=this.code,this.message=u??"An error arised while trying to perform a segment request"}};var w=class extends Error{constructor(t,n){super();switch(Object.setPrototypeOf(this,w.prototype),t){case 0:this.code="MultivariantPlaylistMissingExtM3uHeader";break;case 1:this.code="MultivariantPlaylistWithoutVariant";break;case 2:this.code="MultivariantPlaylistMissingUriLineAfterVariant";break;case 4:this.code="MultivariantPlaylistVariantMissingBandwidth";break;case 5:this.code="MultivariantPlaylistInvalidValue";break;case 6:this.code="MultivariantPlaylistMediaTagMissingType";break;case 7:this.code="MultivariantPlaylistMediaTagMissingName";break;case 8:this.code="MultivariantPlaylistMediaTagMissingGroupId";break;case 10:this.code="MultivariantPlaylistOtherParsingError";break;default:this.code="MultivariantPlaylistOtherParsingError";break}this.globalCode=this.code,this.name="WaspMultivariantPlaylistParsingError",this.message=n??"Unknown error when parsing the Multivariant Playlist"}};var I=class extends Error{constructor(t,n,a,i){super();Object.setPrototypeOf(this,I.prototype),this.name="WaspMultivariantPlaylistRequestError",this.url=t;let s=i;switch(n){case _.Status:s=s??(a===void 0?"A Multivariant Playlist HTTP(S) request(s) responded with an invalid status":`A Multivariant Playlist HTTP(S) request(s) responded with a ${a} status`),this.code=c.MultivariantPlaylistBadHttpStatus;break;case _.Timeout:s=s??"A Multivariant Playlist HTTP(S) request(s) did not respond",this.code=c.MultivariantPlaylistRequestTimeout;break;case _.Error:s=s??"A Multivariant Playlist HTTP(S) request(s) failed due to an error.",this.code=c.MultivariantPlaylistRequestError;break;case _.Other:s=s??"A Multivariant Playlist HTTP(S) request(s) failed for an unknown reason.",this.code=c.MultivariantPlaylistRequestOtherError;break;default:this.code=c.MultivariantPlaylistRequestOtherError;break}this.globalCode=this.code,this.message=s??"An error arised while trying to perform a segment request"}};var v=class extends Error{constructor(t,n){super();switch(Object.setPrototypeOf(this,v.prototype),this.name="WaspOtherError",t){case L.MediaSourceAttachmentError:this.code=c.MediaSourceAttachmentError;break;case L.UnfoundLockedVariant:this.code=c.UnfoundLockedVariant;break;case L.NoSupportedVariant:this.code=c.NoSupportedVariant;break;default:this.code=c.Unknown;break}this.globalCode=this.code,this.message=n??"Unknown error"}};var T=class extends Error{constructor(t,n,a){super();switch(Object.setPrototypeOf(this,T.prototype),this.name="WaspSegmentParsingError",t){case C.TransmuxerError:this.code="SegmentTransmuxingError";break;case C.NoResource:case C.NoSourceBuffer:case C.UnknownError:this.code="SegmentParsingOtherError";break;default:this.code="SegmentParsingOtherError";break}this.globalCode=this.code,this.mediaType=n,this.message=a??"Unknown error when parsing a segment"}};var P=class extends Error{constructor(t,n){super();Object.setPrototypeOf(this,P.prototype),this.name="WaspSegmentRequestError",this.url=t.url,this.isInit=t.isInit;let a=n,{mediaType:i}=t,s=Ue(i)+" segment";switch(t.reason){case _.Status:a=a??(t.status===void 0?`${s}'s HTTP(S) request(s) responded with an invalid status`:`${s}'s HTTP(S) request(s) responded with a ${t.status} status`),this.code=c.SegmentBadHttpStatus;break;case _.Timeout:a=a??`${s}'s HTTP(S) request(s) did not respond`,this.code=c.SegmentRequestTimeout;break;case _.Error:a=a??`${s}'s HTTP(S) request(s) failed due to an error.`,this.code=c.SegmentRequestError;break;case _.Other:a=a??`${s}'s HTTP(S) request(s) failed for an unknown reason.`,this.code=c.SegmentRequestOtherError;break;default:this.code=c.SegmentRequestOtherError;break}this.globalCode=this.code,this.message=a??"An error arised while trying to perform a segment request"}};function Ue(r){switch(r){case U.Audio:return"An audio";case U.Video:return"A video"}throw new Error("Unknown MediaType")}var x=class extends Error{constructor(t,n,a){super();switch(Object.setPrototypeOf(this,x.prototype),this.name="WaspSourceBufferCreationError",this.mediaType=n,t){case S.CantPlayType:this.code="SourceBufferCantPlayType";break;case S.AlreadyCreatedWithSameType:case S.EmptyMimeType:case S.MediaSourceIsClosed:case S.NoMediaSourceAttached:case S.QuotaExceededError:case S.Unknown:this.code="SourceBufferCantPlayType";break;default:this.code="SourceBufferCreationOtherError"}this.globalCode=this.code,this.message=a??"Unknown error when creating SourceBuffer"}};var M=class extends Error{constructor(t,n,a,i){super();switch(Object.setPrototypeOf(this,M.prototype),this.name="WaspSourceBufferError",this.mediaType=a,n){case null:this.code="SourceBufferRemoveError";break;case Q.BufferFull:this.code="SourceBufferFullError";break;case Q.UnknownError:this.code="SourceBufferAppendError";break;default:this.code="SourceBufferOtherError";break}this.globalCode=this.code,this.message=i??"Unknown error"}};function l(r,e,t){o.debug("--> sending to worker:",e.type),t===void 0?r.postMessage(e):r.postMessage(e,t)}var G=(a=>(a.Stopped="Stopped",a.Loading="Loading",a.Loaded="Loaded",a.Error="Error",a))(G||{});var Ae='video/mp2t;codecs="avc1.4D401F"',Be=navigator.userAgent.toLowerCase().indexOf("firefox")!==-1;function K(){return Be?!1:typeof MediaSource=="function"&&MediaSource.isTypeSupported(Ae)}function A(r,e){return r instanceof Error?{message:r.message,name:r.name}:{message:e,name:void 0}}function z(r,e){r.playbackObserver!==null&&(r.playbackObserver.stop(),r.playbackObserver=null),r.loadingAborter!==void 0&&(r.loadingAborter.abort(),r.loadingAborter=void 0),e!==null&&l(e,{type:"stop",value:{contentId:r.contentId}})}function X(r,e){return new Promise((t,n)=>{r.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA&&t(),e.addEventListener("abort",i),r.addEventListener("canplay",a);function a(){r.removeEventListener("canplay",a),e.removeEventListener("abort",i),t()}function i(){r.removeEventListener("canplay",a),e.removeEventListener("abort",i),e.reason!==null?n(e.reason):n(new Error("The loading operation was aborted"))}})}function J(r){let{textTracks:e}=r;if(e!=null){for(let t=0;t<e.length;t++)e[t].mode="disabled";if(r.hasChildNodes()){let{childNodes:t}=r;for(let n=t.length-1;n>=0;n--)if(t[n].nodeName==="track")try{r.removeChild(t[n])}catch(a){let i=a instanceof Error?a.toString():"Unknown Error";o.warn("Unable to remove track element from media element",i)}}}r.src="",r.removeAttribute("src")}var j=class{constructor(e){this._sourceBuffer=e,this._queue=[],this._pendingTask=null;let t=setInterval(()=>{this._flush()},2e3),n=this._onPendingTaskError.bind(this),a=()=>{this._flush()};e.addEventListener("error",n),e.addEventListener("updateend",a),this._dispose=[()=>{clearInterval(t),e.removeEventListener("error",n),e.removeEventListener("updateend",a)}]}push(e){return o.debug("QSB: receiving order to push data to the SourceBuffer"),this._addToQueue({type:0,value:e})}removeBuffer(e,t){return o.debug("QSB: receiving order to remove data from the SourceBuffer",e,t),this._addToQueue({type:1,value:{start:e,end:t}})}getBufferedRanges(){return this._sourceBuffer.buffered}dispose(){for(this._dispose.forEach(e=>e()),this._pendingTask!==null&&(this._pendingTask.reject(new Error("QueuedSourceBuffer Cancelled")),this._pendingTask=null);this._queue.length>0;){let e=this._queue.shift();e!==void 0&&e.reject(new Error("QueuedSourceBuffer Cancelled"))}}_onPendingTaskError(e){let t=e instanceof Error?e:new Error("An unknown error occured when doing operations on the SourceBuffer");this._pendingTask!=null&&this._pendingTask.reject(t)}_addToQueue(e){return new Promise((t,n)=>{let a=this._queue.length===0&&this._pendingTask===null,i={resolve:t,reject:n,...e};this._queue.push(i),a&&this._flush()})}_flush(){if(!this._sourceBuffer.updating){if(this._pendingTask!==null){let e=this._pendingTask,{resolve:t}=e;return this._pendingTask=null,t(),this._flush()}else{let e=this._queue.shift();if(e===void 0)return;this._pendingTask=e}try{switch(this._pendingTask.type){case 0:let e=this._pendingTask.value;if(e===void 0){this._flush();return}o.debug("QSB: pushing data"),this._sourceBuffer.appendBuffer(e);break;case 1:let{start:t,end:n}=this._pendingTask.value;o.debug("QSB: removing data from SourceBuffer",t,n),this._sourceBuffer.remove(t,n);break;default:W(this._pendingTask)}}catch(e){this._onPendingTaskError(e)}}}};function B(r){let e=new Float64Array(r.length*2);for(let t=0;t<r.length;t++){let n=t*2;e[n]=r.start(t),e[n+1]=r.end(t)}return e}var Le=[["seeking",p.Seeking],["seeked",p.Seeked],["loadedmetadata",p.LoadedMetadata],["loadeddata",p.LoadedData],["canplay",p.CanPlay],["canplaythrough",p.CanPlayThrough],["ended",p.Ended],["pause",p.Pause],["play",p.Play],["ratechange",p.RateChange],["stalled",p.Stalled]],q=class extends h{constructor(t,n){super();this._mediaElement=t,this._stop=null,this._minimumObservationInterval=n,this._currentTimeoutId=null,this._lastObservationTimeStamp=0}start(){if(this._stop!==null)return;let t=!1,n=Le.map(([a,i])=>{let s=()=>{this._generateObservation(i)};return this._mediaElement.addEventListener(a,s),()=>this._mediaElement.removeEventListener(a,s)});this._stop=()=>{t||(t=!0,n.forEach(a=>a()),n.length=0)},this._generateObservation(p.Init)}updateMinimumObservationInterval(t){if(t!==this._minimumObservationInterval&&(this._minimumObservationInterval=t,this._stop!==null)){let n=performance.now()-this._lastObservationTimeStamp,a=this._minimumObservationInterval-n;this._currentTimeoutId=window.setTimeout(()=>{this._generateObservation(p.RegularInterval)},a)}}stop(){this._stop!==null&&(this._stop(),this._stop=null),this._currentTimeoutId!==null&&(clearTimeout(this._currentTimeoutId),this._currentTimeoutId=null)}_generateObservation(t){if(this._stop===null){this._currentTimeoutId=null;return}this._currentTimeoutId!==null&&(clearTimeout(this._currentTimeoutId),this._currentTimeoutId=null);let n=B(this._mediaElement.buffered),{currentTime:a,readyState:i,paused:s,seeking:u,ended:m,duration:b}=this._mediaElement;this._lastObservationTimeStamp=performance.now(),this.trigger("newObservation",{reason:t,currentTime:a,readyState:i,buffered:n,paused:s,seeking:u,ended:m,duration:b}),this._currentTimeoutId=window.setTimeout(()=>{this._generateObservation(p.RegularInterval)},this._minimumObservationInterval)}};var Z=300,Ce=1e3;function ee(r,e,t){if(e?.contentId!==r.value.contentId){o.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}if(e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null),r.value.handle!==void 0)t.srcObject=r.value.handle;else if(r.value.src!==void 0)t.src=r.value.src;else throw new Error('Unexpected "attach-media-source" message: missing source');e.mediaSourceId=r.value.mediaSourceId,e.mediaSource=null,e.disposeMediaSource=()=>{r.value.src!==void 0&&URL.revokeObjectURL(r.value.src)},e.sourceBuffers=[]}function re(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring seek due to wrong `mediaSourceId`");return}try{t.currentTime=r.value.position}catch(n){let a=n instanceof Error?n:"Unknown Error";o.error("Unexpected error while seeking:",a)}}function te(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring flush due to wrong `mediaSourceId`");return}try{t.currentTime=t.currentTime-.001}catch(n){let a=n instanceof Error?n:"Unknown Error";o.error("Unexpected error while flushing:",a)}}function ne(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring playback rate update due to wrong `mediaSourceId`");return}try{t.playbackRate=r.value.playbackRate}catch(n){let a=n instanceof Error?n:"Unknown Error";o.error("Unexpected error while changing the playback rate:",a)}}function ae(r,e,t,n){if(e?.contentId!==r.value.contentId)o.info("API: Ignoring MediaSource attachment due to wrong `contentId`");else{let{mediaSourceId:a}=r.value;try{e.disposeMediaSource!==null&&(e.disposeMediaSource(),e.disposeMediaSource=null),e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null);let i=new MediaSource,s=Re(n,i,t,a);e.mediaSourceId=r.value.mediaSourceId,e.mediaSource=i,e.disposeMediaSource=s,e.sourceBuffers=[]}catch(i){let{name:s,message:u}=A(i,"Unknown error when creating the MediaSource");l(n,{type:"create-ms",value:{mediaSourceId:a,message:u,name:s}})}}}function oe(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring duration update due to wrong `mediaSourceId`");return}try{e.mediaSource===null?o.info("API: Ignoring duration update due to no MediaSource"):e.mediaSource.duration=r.value.duration}catch(n){let{name:a,message:i}=A(n,"Unknown error when updating the MediaSource's duration"),{mediaSourceId:s}=r.value;l(t,{type:"update-ms-dur-err",value:{mediaSourceId:s,message:i,name:a}})}}function ie(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring MediaSource clearing due to wrong `mediaSourceId`");return}try{e.disposeMediaSource!==null&&(e.disposeMediaSource(),e.disposeMediaSource=null),J(t)}catch(n){let a=n instanceof Error?n:"Unknown Error";o.warn("API: Error when clearing current MediaSource:",a)}}function se(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring SourceBuffer creation due to wrong `mediaSourceId`");return}if(e.mediaSource===null){l(t,{type:"create-sb",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{let n=e.mediaSource.addSourceBuffer(r.value.contentType),a=new j(n);e.sourceBuffers.push({sourceBufferId:r.value.sourceBufferId,queuedSourceBuffer:a})}catch(n){let{name:a,message:i}=A(n,"Unknown error when adding the SourceBuffer to the MediaSource");l(t,{type:"create-sb",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:1,message:i,name:a}})}}function ue(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring appendBuffer operation due to wrong `mediaSourceId`");return}let n=e.sourceBuffers.find(({sourceBufferId:a})=>a===r.value.sourceBufferId);if(n!==void 0){let s=function(u){let{message:m}=A(u,"Unknown error when appending data to the SourceBuffer");l(t,{type:"sb-err",value:{mediaSourceId:a,sourceBufferId:i,message:m,operation:0,isBufferFull:u instanceof Error&&u.name==="QuotaExceededError"}})},{mediaSourceId:a,sourceBufferId:i}=r.value;try{n.queuedSourceBuffer.push(r.value.data).then(()=>{let u=n.queuedSourceBuffer.getBufferedRanges();l(t,{type:"sb-s",value:{mediaSourceId:a,sourceBufferId:i,buffered:B(u)}})}).catch(s)}catch(u){s(u)}}}function de(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring removeBuffer operation due to wrong `mediaSourceId`");return}let n=e.sourceBuffers.find(({sourceBufferId:a})=>a===r.value.sourceBufferId);if(n!==void 0){let s=function(u){let{message:m}=A(u,"Unknown error when removing data to the SourceBuffer");l(t,{type:"sb-err",value:{mediaSourceId:a,sourceBufferId:i,message:m,operation:1,isBufferFull:!1}})},{mediaSourceId:a,sourceBufferId:i}=r.value;try{n.queuedSourceBuffer.removeBuffer(r.value.start,r.value.end).then(()=>{let u=n.queuedSourceBuffer.getBufferedRanges();l(t,{type:"sb-s",value:{mediaSourceId:a,sourceBufferId:i,buffered:B(u)}})}).catch(s)}catch(u){s(u)}}}function le(r,e,t,n){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring `start-playback-observation` due to wrong `mediaSourceId`");return}e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null),e.playbackObserver=new q(t,Z),e.playbackObserver.addEventListener("newObservation",a=>{let i={};for(let s of e.sourceBuffers){let u=s.queuedSourceBuffer.getBufferedRanges(),m=B(u);i[s.sourceBufferId]=m}l(n,{type:"obs",value:Object.assign(a,{sourceBuffersBuffered:i,mediaSourceId:r.value.mediaSourceId})})}),e.playbackObserver.start()}function ce(r,e){if(e?.mediaSourceId!==r.value.mediaSourceId){o.info("API: Ignoring `stop-playback-observation` due to wrong `mediaSourceId`");return}e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null)}function fe(r,e,t){if(e?.mediaSourceId!==r.value.mediaSourceId)o.info("API: Ignoring `end-of-stream` due to wrong `mediaSourceId`");else{let{mediaSourceId:n}=r.value;if(e.mediaSource===null){l(t,{type:"eos-err",value:{mediaSourceId:n,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}if(e.mediaSource.readyState==="ended"){o.info("Ignoring redundant end-of-stream order");return}try{e.mediaSource.endOfStream()}catch(a){let{name:i,message:s}=A(a,"Unknown error when calling MediaSource.endOfStream()");l(t,{type:"eos-err",value:{mediaSourceId:n,code:1,message:s,name:i}})}}}function pe(r,e){if(e?.contentId!==r.value.contentId){o.info("API: Ignoring media offset update due to wrong `contentId`");return}e.mediaOffset=r.value.offset}function _e(r,e,t){return e?.mediaSourceId!==r.value.mediaSourceId?(o.info("API: Ignoring rebuffering start due to wrong `mediaSourceId`"),!1):(e.playbackObserver?.updateMinimumObservationInterval(Z),r.value.updatePlaybackRate&&(t.playbackRate=0),e.isRebuffering?!1:(e.isRebuffering=!0,!0))}function me(r,e,t){return e?.mediaSourceId!==r.value.mediaSourceId?(o.info("API: Ignoring rebuffering end due to wrong `mediaSourceId`"),!1):(e.playbackObserver?.updateMinimumObservationInterval(Ce),t.playbackRate===0&&e.wantedSpeed!==0&&(t.playbackRate=e.wantedSpeed),e.isRebuffering?(e.isRebuffering=!1,!0):!1)}function be(r,e){if(e?.contentId!==r.value.contentId)return o.info("API: Ignoring error due to wrong `contentId`"),null;e.loadingAborter!==void 0&&e.loadingAborter.abort(new Error("Could not load content due to an error")),e.disposeMediaSource!==null&&(e.disposeMediaSource(),e.disposeMediaSource=null),e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null),e.playbackObserver=null;let t=ge(r);return e.error=t,t}function ge(r){switch(r.value.errorInfo.type){case"segment-request":return new P(r.value.errorInfo.value,r.value.message);case"multi-var-playlist-request":return new I(r.value.errorInfo.value.url,r.value.errorInfo.value.reason,r.value.errorInfo.value.status,r.value.message);case"media-playlist-request":return new E(r.value.errorInfo.value.url,r.value.errorInfo.value.reason,r.value.errorInfo.value.status,r.value.errorInfo.value.mediaType,r.value.message);case"other-error":return new v(r.value.errorInfo.value.code,r.value.message);case"sb-creation":return new x(r.value.errorInfo.value.code,r.value.errorInfo.value.mediaType,r.value.message);case"multi-var-playlist-parse":return new w(r.value.errorInfo.value.code,r.value.message);case"media-playlist-parse":return new k(r.value.errorInfo.value.mediaType,r.value.errorInfo.value.code,r.value.message);case"segment-parse":return new T(r.value.errorInfo.value.code,r.value.errorInfo.value.mediaType,r.value.message);case"push-segment-error":return new M(0,r.value.errorInfo.value.code,r.value.errorInfo.value.mediaType,r.value.message);case"remove-buffer-error":return new M(1,null,r.value.errorInfo.value.mediaType,r.value.message);case"unitialized":return new v(L.Unknown,r.value.message);default:W(r.value.errorInfo)}}function he(r,e){return e?.contentId!==r.value.contentId?(o.info("API: Ignoring warning due to wrong `contentId`"),null):ge(r)}function ye(r,e){if(e?.contentId!==r.value.contentId){o.info("API: Ignoring warning due to wrong `contentId`");return}e.minimumPosition=r.value.minimumPosition,e.maximumPosition=r.value.maximumPosition}function ve(r,e){return e?.contentId!==r.value.contentId?(o.info("API: Ignoring warning due to wrong `contentId`"),!1):(e.variants=r.value.variants,e.audioTracks=r.value.audioTracks,!0)}function Me(r,e){return e?.contentId!==r.value.contentId?(o.info("API: Ignoring warning due to wrong `contentId`"),!1):r.value.mediaType!==U.Audio?(o.warn("API: track update for a type not handled for now"),!1):(e.currentAudioTrack=r.value.audioTrack?{id:r.value.audioTrack.current,isSelected:r.value.audioTrack.isSelected}:void 0,!0)}function Se(r,e){if(e?.contentId!==r.value.contentId)return o.info("API: Ignoring warning due to wrong `contentId`"),!1;let t=e.variants.find(n=>n.id===r.value.variantId);return t===void 0&&o.warn("API: VariantUpdate for an unfound variant"),t!==e.currVariant?(e.currVariant=t,!0):!1}function ke(r,e){if(e?.contentId!==r.value.contentId)return o.info("API: Ignoring warning due to wrong `contentId`"),!1;if(r.value.lockedVariant===null)return e.lockedVariant!==null?(e.lockedVariant=null,!0):!1;let t=e.variants.find(n=>n.id===r.value.lockedVariant);return t===void 0?(o.warn("API: VariantLockStatusChange for an unfound variant"),e.lockedVariant!==null?(e.lockedVariant=null,!0):!1):t!==e.lockedVariant?(e.lockedVariant=t,!0):!1}function Ee(r,e){return e?.contentId!==r.value.contentId?(o.info("API: Ignoring `content-stopped` due to wrong `contentId`"),!1):(e.disposeMediaSource!==null&&(e.disposeMediaSource(),e.disposeMediaSource=null),e.playbackObserver!==null&&(e.playbackObserver.stop(),e.playbackObserver=null),e.playbackObserver=null,e.loadingAborter?.abort(new Error("Content Stopped")),!0)}function Re(r,e,t,n){e.addEventListener("sourceclose",u),e.addEventListener("sourceended",i),e.addEventListener("sourceopen",s);let a=URL.createObjectURL(e);t.src=a;function i(){l(r,{type:"ms-state",value:{mediaSourceId:n,state:R.Ended}})}function s(){l(r,{type:"ms-state",value:{mediaSourceId:n,state:R.Open}})}function u(){l(r,{type:"ms-state",value:{mediaSourceId:n,state:R.Closed}})}return()=>{if(e.removeEventListener("sourceclose",u),e.removeEventListener("sourceended",i),e.removeEventListener("sourceopen",s),URL.revokeObjectURL(a),e.readyState!=="closed"){let{readyState:m,sourceBuffers:b}=e;for(let d=b.length-1;d>=0;d--){let f=b[d];if(!f.updating)try{m==="open"&&f.abort(),e.removeSourceBuffer(f)}catch(N){let Ie=N instanceof Error?N:"Unknown Error";o.warn("Could not remove SourceBuffer",Ie)}}}t.src="",t.removeAttribute("src")}}function we(r,e){let t={};for(let n of r.value.mimeTypes)t[n]=MediaSource.isTypeSupported(n);l(e,{type:"codecs-support-upd",value:{mimeTypes:t}})}var je=H();var V=class extends h{constructor(t,n){super();this.videoElement=t,this.initializationStatus="Uninitialized",this.__worker__=null,this.__contentMetadata__=null,this.__logLevelChangeListener__=null,this.__destroyAbortController__=new AbortController,this.__config__={...$,...n??{}};let a=()=>{this.getPlayerState()==="Loaded"&&this.trigger("paused",null)},i=()=>{this.getPlayerState()==="Loaded"&&this.trigger("ended",null)},s=()=>{this.getPlayerState()==="Loaded"&&this.__contentMetadata__!==null&&this.trigger("playing",null)};this.videoElement.addEventListener("pause",a),this.videoElement.addEventListener("play",s),this.videoElement.addEventListener("ended",i),this.__destroyAbortController__.signal.addEventListener("abort",()=>{this.videoElement.removeEventListener("pause",a),this.videoElement.removeEventListener("play",s),this.videoElement.removeEventListener("ended",i)})}initialize(t){try{if(this.initializationStatus!=="Uninitialized")throw new Error("WaspHlsPlayer already initialized");this.initializationStatus="Initializing";let{wasmUrl:n,workerUrl:a}=t,i=g,s=g,u=new Promise((m,b)=>{i=m,s=b});return this.__startWorker__(a,n,i,s),u}catch(n){return this.initializationStatus="errored",Promise.reject(n)}}getConfig(){return this.__config__}updateConfig(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__config__={...this.__config__,...t},l(this.__worker__,{type:"upd-conf",value:this.__config__})}load(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&z(this.__contentMetadata__,this.__worker__);let n=je(),a=new AbortController;this.__contentMetadata__={contentId:n,mediaSourceId:null,mediaSource:null,disposeMediaSource:null,sourceBuffers:[],variants:[],audioTracks:[],currentAudioTrack:void 0,currVariant:void 0,lockedVariant:null,playbackObserver:null,isRebuffering:!1,mediaOffset:void 0,wantedSpeed:1,minimumPosition:void 0,maximumPosition:void 0,loadingAborter:a,error:null},this.trigger("playerStateChange","Loading"),l(this.__worker__,{type:"load",value:{contentId:n,url:t}})}getPlayerState(){return this.__contentMetadata__===null?"Stopped":this.__contentMetadata__.error!==null?"Error":this.__contentMetadata__.loadingAborter!==void 0?"Loading":"Loaded"}getPosition(){return this.__contentMetadata__===null?0:this.videoElement.currentTime-(this.__contentMetadata__.mediaOffset??0)}seek(t){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot seek: no content loaded.");this.videoElement.currentTime=t+(this.__contentMetadata__?.mediaOffset??0)}getMediaOffset(){return this.__contentMetadata__?.mediaOffset??void 0}isPlaying(){return this.getPlayerState()==="Loaded"&&!this.videoElement.paused}isPaused(){return this.videoElement.paused}isEnded(){return this.videoElement.ended}isRebuffering(){return this.__contentMetadata__?.isRebuffering??!1}pause(){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot pause: no content loaded.");this.videoElement.pause()}resume(){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot resume: no content loaded.");this.videoElement.play().catch(()=>{})}stop(){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&z(this.__contentMetadata__,this.__worker__)}setSpeed(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null||this.__contentMetadata__.mediaSourceId===null)throw new Error("No content is loaded");this.__contentMetadata__.wantedSpeed=t,l(this.__worker__,{type:"upd-speed",value:{mediaSourceId:this.__contentMetadata__.mediaSourceId,wantedSpeed:t}})}getSpeed(){return this.__contentMetadata__?.wantedSpeed??1}getMinimumPosition(){return this.__contentMetadata__?.minimumPosition}getMaximumPosition(){return this.__contentMetadata__?.maximumPosition}getError(){return this.__contentMetadata__?.error??null}getCurrentVariant(){return this.__contentMetadata__?.currVariant??void 0}getVariantList(){return this.__contentMetadata__?.variants??[]}getAudioTrackList(){return this.__contentMetadata__?.audioTracks??[]}getAudioTrack(){let t=this.__contentMetadata__?.currentAudioTrack?.id;if(t!==void 0)return this.getAudioTrackList()?.find(n=>n.id===t)}setAudioTrack(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");l(this.__worker__,{type:"set-audio",value:{contentId:this.__contentMetadata__.contentId,trackId:t}})}lockVariant(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");l(this.__worker__,{type:"lock-var",value:{contentId:this.__contentMetadata__.contentId,variantId:t}})}unlockVariant(){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");l(this.__worker__,{type:"lock-var",value:{contentId:this.__contentMetadata__.contentId,variantId:null}})}getLockedVariant(){return this.__contentMetadata__?.lockedVariant??null}dispose(){this.__destroyAbortController__.abort(),this.__worker__!==null&&(this.__contentMetadata__!==null&&z(this.__contentMetadata__,this.__worker__),l(this.__worker__,{type:"dispose",value:null}),this.__worker__=null,this.__logLevelChangeListener__!==null&&o.removeEventListener("onLogLevelChange",this.__logLevelChangeListener__))}__startWorker__(t,n,a,i){let s=!0,u=new Worker(t);this.__worker__=u,l(u,{type:"init",value:{hasMseInWorker:typeof MediaSource=="function"&&MediaSource.canConstructInDedicatedWorker===!0,canDemuxMpeg2Ts:K(),wasmUrl:n,logLevel:o.getLevel(),initialConfig:this.__config__}}),this.__logLevelChangeListener__!==null&&o.removeEventListener("onLogLevelChange",this.__logLevelChangeListener__),o.addEventListener("onLogLevelChange",m),this.__logLevelChangeListener__=m,u.onmessage=b=>{let{data:d}=b;if(typeof d!="object"||d===null||typeof d.type>"u"){o.error("unexpected Worker message");return}switch(d.type){case"init":this.initializationStatus="Initialized",s=!1,a();break;case"init-err":if(s){let f=new y(d.value.code,d.value.wasmHttpStatus,d.value.message??"Error while initializing the WaspHlsPlayer");s=!1,i(f)}break;case"seek":re(d,this.__contentMetadata__,this.videoElement);break;case"flush":te(d,this.__contentMetadata__,this.videoElement);break;case"upd-pbr":ne(d,this.__contentMetadata__,this.videoElement);break;case"attach-ms":ee(d,this.__contentMetadata__,this.videoElement);break;case"create-ms":ae(d,this.__contentMetadata__,this.videoElement,u);break;case"upd-ms-dur":oe(d,this.__contentMetadata__,u);break;case"clear-ms":ie(d,this.__contentMetadata__,this.videoElement);break;case"creat-sb":se(d,this.__contentMetadata__,u);break;case"push-sb":ue(d,this.__contentMetadata__,u);break;case"rem-sb":de(d,this.__contentMetadata__,u);break;case"start-obs":le(d,this.__contentMetadata__,this.videoElement,u);break;case"stop-obs":ce(d,this.__contentMetadata__);break;case"eos":fe(d,this.__contentMetadata__,u);break;case"media-off-upd":pe(d,this.__contentMetadata__);break;case"m-playlist":ve(d,this.__contentMetadata__)&&(this.trigger("variantListUpdate",this.getVariantList()),this.trigger("audioTrackListUpdate",this.getAudioTrackList()));break;case"track-upd":Me(d,this.__contentMetadata__)&&d.value.mediaType===U.Audio&&this.trigger("audioTrackUpdate",this.getAudioTrack());break;case"variant-upd":Se(d,this.__contentMetadata__)&&this.trigger("variantUpdate",this.getCurrentVariant());break;case"variant-lck-upd":ke(d,this.__contentMetadata__)&&this.trigger("variantLockUpdate",this.getLockedVariant());break;case"err":{let f=be(d,this.__contentMetadata__);f!==null&&(o.error("API: sending fatal error",f),this.trigger("error",f),this.trigger("playerStateChange","Error"));break}case"warn":{let f=he(d,this.__contentMetadata__);f!==null&&(o.warn("API: Triggering warning",f),this.trigger("warning",f));break}case"time-upd":ye(d,this.__contentMetadata__);break;case"ctnt-stop":Ee(d,this.__contentMetadata__)&&(this.__contentMetadata__=null,this.trigger("playerStateChange","Stopped"));break;case"rebuf-start":_e(d,this.__contentMetadata__,this.videoElement)&&this.trigger("rebufferingStarted",null);break;case"rebuf-end":me(d,this.__contentMetadata__,this.videoElement)&&(this.trigger("rebufferingEnded",null),this.__contentMetadata__?.loadingAborter!==void 0&&X(this.videoElement,this.__contentMetadata__.loadingAborter.signal).then(()=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0),this.trigger("playerStateChange","Loaded")},f=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0);let N=f instanceof Error?f:"Unknown reason";o.info("Could not load content:",N)}));break;case"are-types-supp":we(d,u);break;default:W(d)}},u.onerror=b=>{let d=b.error instanceof Error?b.error:"Unknown Error";o.error("API: Worker Error encountered",d),s&&i(new y(2,void 0,b.error?.message??void 0)),this.dispose()};function m(b){l(u,{type:"upd-log",value:b})}}};var Fn=V;})();
