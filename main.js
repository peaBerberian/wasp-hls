(()=>{function T(){let n="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(n+="0",e=0),n+String(e)}}var M=class{constructor(e){this._sourceBuffer=e,this._queue=[],this._pendingTask=null;let t=setInterval(()=>{this._flush()},2e3),o=this._onPendingTaskError.bind(this),a=()=>{this._flush()};e.addEventListener("error",o),e.addEventListener("updateend",a),this._dispose=[()=>{clearInterval(t),e.removeEventListener("error",o),e.removeEventListener("updateend",a)}]}push(e){return console.debug("QSB: receiving order to push data to the SourceBuffer"),this._addToQueue({type:0,value:e})}removeBuffer(e,t){return console.debug("QSB: receiving order to remove data from the SourceBuffer",e,t),this._addToQueue({type:1,value:{start:e,end:t}})}getBufferedRanges(){return this._sourceBuffer.buffered}dispose(){for(this._dispose.forEach(e=>e()),this._pendingTask!==null&&(this._pendingTask.reject(new Error("QueuedSourceBuffer Cancelled")),this._pendingTask=null);this._queue.length>0;){let e=this._queue.shift();e!==void 0&&e.reject(new Error("QueuedSourceBuffer Cancelled"))}}_onPendingTaskError(e){let t=e instanceof Error?e:new Error("An unknown error occured when doing operations on the SourceBuffer");this._pendingTask!=null&&this._pendingTask.reject(t)}_addToQueue(e){return new Promise((t,o)=>{let a=this._queue.length===0&&this._pendingTask===null,i={resolve:t,reject:o,...e};this._queue.push(i),a&&this._flush()})}_flush(){if(!this._sourceBuffer.updating){if(this._pendingTask!==null){let e=this._pendingTask,{resolve:t}=e;return this._pendingTask=null,t(),this._flush()}else{let e=this._queue.shift();if(e===void 0)return;this._pendingTask=e}try{switch(this._pendingTask.type){case 0:let e=this._pendingTask.value;if(e===void 0){this._flush();return}console.debug("QSB: pushing data"),this._sourceBuffer.appendBuffer(e);break;case 1:let{start:t,end:o}=this._pendingTask.value;console.debug("QSB: removing data from SourceBuffer",t,o),this._sourceBuffer.remove(t,o);break;default:B(this._pendingTask)}}catch(e){this._onPendingTaskError(e)}}}};function B(n){throw new Error("Unreachable path taken")}var W=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});W.decode();var Q=new Uint8Array;var F=new Int32Array;var x=new TextEncoder("utf-8"),D=typeof x.encodeInto=="function"?function(n,e){return x.encodeInto(n,e)}:function(n,e){let t=x.encode(n);return e.set(t),{read:n.length,written:t.length}};var H=new Float64Array;var V=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),G=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),X=Object.freeze({UnknownError:0,0:"UnknownError",NoContentLoaded:1,1:"NoContentLoaded"}),$=Object.freeze({SourceBufferNotFound:0,0:"SourceBufferNotFound",UnknownError:1,1:"UnknownError"}),J=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),K=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",MediaSourceIsClosed:1,1:"MediaSourceIsClosed",QuotaExceededError:2,2:"QuotaExceededError",TypeNotSupportedError:3,3:"TypeNotSupportedError",EmptyMimeType:4,4:"EmptyMimeType",UnknownError:5,5:"UnknownError"}),Y=Object.freeze({NoResource:0,0:"NoResource",NoSourceBuffer:1,1:"NoSourceBuffer",TransmuxerError:2,2:"TransmuxerError",UnknownError:3,3:"UnknownError"}),Z=Object.freeze({Init:0,0:"Init",Seeked:1,1:"Seeked",Seeking:2,2:"Seeking",Ended:3,3:"Ended",ReadyStateChanged:4,4:"ReadyStateChanged",RegularInterval:5,5:"RegularInterval",Error:6,6:"Error"}),ee=Object.freeze({MediaPlaylistRefresh:0,0:"MediaPlaylistRefresh"}),te=Object.freeze({Error:0,0:"Error",Warn:1,1:"Warn",Info:2,2:"Info",Debug:3,3:"Debug"}),re=Object.freeze({Audio:0,0:"Audio",Video:1,1:"Video"}),w=Object.freeze({Closed:0,0:"Closed",Ended:1,1:"Ended",Open:2,2:"Open"}),l=Object.freeze({Init:0,0:"Init",Seeking:1,1:"Seeking",Seeked:2,2:"Seeked",RegularInterval:3,3:"RegularInterval",LoadedData:4,4:"LoadedData",LoadedMetadata:5,5:"LoadedMetadata",CanPlay:6,6:"CanPlay",CanPlayThrough:7,7:"CanPlayThrough",Ended:8,8:"Ended",Pause:9,9:"Pause",Play:10,10:"Play",RateChange:11,11:"RateChange",Stalled:12,12:"Stalled"});var g=class extends Error{constructor(t,o,a){super();Object.setPrototypeOf(this,g.prototype),this.name="InitializationError",this.code=t,this.wasmHttpStatus=o,this.message=a}};var S=class{constructor(){this._listeners={}}addEventListener(e,t){let o=this._listeners[e];Array.isArray(o)?o.push(t):this._listeners[e]=[t]}removeEventListener(e,t){if(e===void 0){this._listeners={};return}let o=this._listeners[e];if(!Array.isArray(o))return;if(t===void 0){delete this._listeners[e];return}let a=o.indexOf(t);a!==-1&&o.splice(a,1),o.length===0&&delete this._listeners[e]}trigger(e,t){let o=this._listeners[e];!Array.isArray(o)||o.slice().forEach(a=>{try{a(t)}catch(i){console.error("EventEmitter: listener error",i instanceof Error?i:null)}})}};var L=[["seeking",l.Seeking],["seeked",l.Seeked],["loadedmetadata",l.LoadedMetadata],["loadeddata",l.LoadedData],["canplay",l.CanPlay],["canplaythrough",l.CanPlayThrough],["ended",l.Ended],["pause",l.Pause],["play",l.Play],["ratechange",l.RateChange],["stalled",l.Stalled]];function P(n,e,t){let o=!1,a,i=L.map(([c,p])=>{n.addEventListener(c,r);function r(){f(p)}return()=>n.removeEventListener(c,r)});return Promise.resolve().then(()=>f(l.Init)),()=>{o||(o=!0,i.forEach(c=>c()),i.length=0,a!==void 0&&(clearTimeout(a),a=void 0))};function f(c){if(o)return;a!==void 0&&(clearTimeout(a),a=void 0);let p=new Float64Array(n.buffered.length*2);for(let d=0;d<n.buffered.length;d++){let b=d*2;p[b]=n.buffered.start(d),p[b+1]=n.buffered.end(d)}let{currentTime:r,readyState:h,paused:s,seeking:_}=n;t({mediaSourceId:e,reason:c,currentTime:r,readyState:h,buffered:p,paused:s,seeking:_}),a=window.setTimeout(()=>{if(o){a=void 0;return}f(l.RegularInterval)},1e3)}}function u(n,e,t){console.debug("--> sending to worker:",e.type),t===void 0?n.postMessage(e):n.postMessage(e,t)}var C=T(),j=(a=>(a[a.Stopped=0]="Stopped",a[a.Loading=1]="Loading",a[a.Loaded=2]="Loaded",a[a.Error=3]="Error",a))(j||{}),E=class extends S{constructor(t){super();this.videoElement=t,this.initializationStatus=k.Uninitialized,this.__worker__=null,this.__contentMetadata__=null}initialize(t){try{this.initializationStatus=k.Initializing;let{wasmUrl:o,workerUrl:a}=t,i=A,f=A,c=new Promise((p,r)=>{i=p,f=r});return this.__startWorker__(a,o,i,f),c}catch(o){return this.initializationStatus=k.Errored,Promise.reject(o)}}loadContent(t){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&O(this.__contentMetadata__,this.__worker__);let o=C(),a=new AbortController;this.__contentMetadata__={contentId:o,mediaSourceId:null,mediaSource:null,disposeMediaSource:null,sourceBuffers:[],stopPlaybackObservations:null,mediaOffset:void 0,minimumPosition:void 0,maximumPosition:void 0,loadingAborter:a,error:null},u(this.__worker__,{type:"load",value:{contentId:o,url:t}}),R(this.videoElement,a.signal).then(()=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0),this.trigger("loaded",null)},i=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0),console.info("Could not load content:",i)})}getPlayerState(){return this.__contentMetadata__===null?0:this.__contentMetadata__.error!==null?3:this.__contentMetadata__.loadingAborter!==void 0?1:2}getPosition(){return this.__contentMetadata__===null?0:this.videoElement.currentTime-(this.__contentMetadata__.mediaOffset??0)}seek(t){if(this.__contentMetadata__===null)throw new Error("Cannot seek: no content loaded.");this.videoElement.currentTime=t+(this.__contentMetadata__.mediaOffset??0)}getMediaOffset(){return this.__contentMetadata__?.mediaOffset??void 0}setVolume(t){this.videoElement.volume=t}mute(){this.videoElement.muted=!0}unmute(){this.videoElement.muted=!1}isPlaying(){return this.getPlayerState()===2&&!this.videoElement.paused}isPaused(){return this.videoElement.paused}pause(){this.videoElement.pause()}resume(){this.videoElement.play().catch(()=>{})}stop(){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&O(this.__contentMetadata__,this.__worker__)}setSpeed(t){this.videoElement.playbackRate=t}getSpeed(){return this.videoElement.playbackRate}getMinimumPosition(){return this.__contentMetadata__?.minimumPosition}getMaximumPosition(){return this.__contentMetadata__?.maximumPosition}getError(){return this.__contentMetadata__?.error??null}dispose(){this.__worker__!==null&&(this.__contentMetadata__!==null&&O(this.__contentMetadata__,this.__worker__),u(this.__worker__,{type:"dispose",value:null}),this.__worker__=null)}__startWorker__(t,o,a,i){let f=!0,c=new Worker(t);this.__worker__=c,u(c,{type:"init",value:{hasWorkerMse:typeof MediaSource=="function"&&MediaSource.canConstructInDedicatedWorker===!0,wasmUrl:o}}),c.onmessage=p=>{let{data:r}=p;if(typeof r!="object"||r===null||typeof r.type!="string"){console.error("unexpected Worker message");return}switch(r.type){case"initialized":this.initializationStatus=k.Initialized,f=!1,a();break;case"initialization-error":if(f){let s=new g(r.value.code,r.value.wasmHttpStatus,r.value.message??"Error while initializing the WaspHlsPlayer");f=!1,i(s)}break;case"seek":if(this.__contentMetadata__===null||this.__contentMetadata__.mediaSourceId!==r.value.mediaSourceId){console.info("API: Ignoring seek due to wrong `mediaSourceId`");return}try{this.videoElement.currentTime=r.value.position}catch(s){console.error("Unexpected error while seeking:",s)}break;case"attach-media-source":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}if(this.__contentMetadata__.stopPlaybackObservations!==null&&(this.__contentMetadata__.stopPlaybackObservations(),this.__contentMetadata__.stopPlaybackObservations=null),r.value.handle!==void 0)this.videoElement.srcObject=r.value.handle;else if(r.value.src!==void 0)this.videoElement.src=r.value.src;else throw new Error('Unexpected "attach-media-source" message: missing source');this.__contentMetadata__.mediaSourceId=r.value.mediaSourceId,this.__contentMetadata__.mediaSource=null,this.__contentMetadata__.disposeMediaSource=()=>{r.value.src!==void 0&&URL.revokeObjectURL(r.value.src)},this.__contentMetadata__.sourceBuffers=[],this.__contentMetadata__.stopPlaybackObservations=null;break;case"create-media-source":{if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}let{mediaSourceId:s}=r.value,_;try{_=new MediaSource}catch(b){let{name:m,message:y}=v(b,"Unknown error when creating the MediaSource");u(c,{type:"create-media-source-error",value:{mediaSourceId:s,message:y,name:m}});return}let d=N(c,_,this.videoElement,s);this.__contentMetadata__.mediaSourceId=r.value.mediaSourceId,this.__contentMetadata__.mediaSource=_,this.__contentMetadata__.disposeMediaSource=d,this.__contentMetadata__.sourceBuffers=[],this.__contentMetadata__.stopPlaybackObservations=null;break}case"update-media-source-duration":{let{mediaSourceId:s}=r.value;if(this.__contentMetadata__?.mediaSourceId!==s||this.__contentMetadata__.mediaSource===null)return;try{this.__contentMetadata__.mediaSource.duration=r.value.duration}catch(_){let{name:d,message:b}=v(_,"Unknown error when updating the MediaSource's duration");u(c,{type:"update-media-source-duration-error",value:{mediaSourceId:s,message:b,name:d}});return}break}case"clear-media-source":{if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;try{this.__contentMetadata__.disposeMediaSource?.(),U(this.videoElement)}catch(s){console.warn("API: Error when clearing current MediaSource:",s)}break}case"create-source-buffer":{if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;if(this.__contentMetadata__.mediaSource===null){u(c,{type:"create-source-buffer-error",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{let s=this.__contentMetadata__.mediaSource.addSourceBuffer(r.value.contentType),_=new M(s);this.__contentMetadata__.sourceBuffers.push({sourceBufferId:r.value.sourceBufferId,queuedSourceBuffer:_})}catch(s){let{name:_,message:d}=v(s,"Unknown error when adding the SourceBuffer to the MediaSource");u(c,{type:"create-source-buffer-error",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:1,message:d,name:_}})}break}case"append-buffer":{let b=function(m){let{name:y,message:I}=v(m,"Unknown error when appending data to the SourceBuffer");u(c,{type:"source-buffer-error",value:{sourceBufferId:d,message:I,name:y}})};if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;let s=this.__contentMetadata__.sourceBuffers.find(({sourceBufferId:m})=>m===r.value.sourceBufferId);if(s===void 0)return;let{mediaSourceId:_,sourceBufferId:d}=r.value;try{s.queuedSourceBuffer.push(r.value.data).then(()=>{u(c,{type:"source-buffer-updated",value:{mediaSourceId:_,sourceBufferId:d}})}).catch(b)}catch(m){b(m)}break}case"remove-buffer":{let b=function(m){let{name:y,message:I}=v(m,"Unknown error when removing data to the SourceBuffer");u(c,{type:"source-buffer-error",value:{sourceBufferId:d,message:I,name:y}})};if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;let s=this.__contentMetadata__.sourceBuffers.find(({sourceBufferId:m})=>m===r.value.sourceBufferId);if(s===void 0)return;let{mediaSourceId:_,sourceBufferId:d}=r.value;try{s.queuedSourceBuffer.removeBuffer(r.value.start,r.value.end).then(()=>{u(c,{type:"source-buffer-updated",value:{mediaSourceId:_,sourceBufferId:d}})}).catch(b)}catch(m){b(m)}break}case"start-playback-observation":{if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;this.__contentMetadata__.stopPlaybackObservations!==null&&(this.__contentMetadata__.stopPlaybackObservations(),this.__contentMetadata__.stopPlaybackObservations=null),this.__contentMetadata__.stopPlaybackObservations=P(this.videoElement,r.value.mediaSourceId,s=>u(c,{type:"observation",value:s}));break}case"stop-playback-observation":{if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;this.__contentMetadata__.stopPlaybackObservations!==null&&(this.__contentMetadata__.stopPlaybackObservations(),this.__contentMetadata__.stopPlaybackObservations=null);break}case"end-of-stream":if(this.__contentMetadata__?.mediaSourceId!==r.value.mediaSourceId)return;let{mediaSourceId:h}=r.value;if(this.__contentMetadata__.mediaSource===null){u(c,{type:"end-of-stream-error",value:{mediaSourceId:h,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{this.__contentMetadata__.mediaSource.endOfStream()}catch(s){let{name:_,message:d}=v(s,"Unknown error when calling MediaSource.endOfStream()");u(c,{type:"end-of-stream-error",value:{mediaSourceId:h,code:1,message:d,name:_}})}break;case"media-offset-update":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring media offset update due to wrong `contentId`");return}this.__contentMetadata__.mediaOffset=r.value.offset;break;case"content-error":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring warning due to wrong `contentId`");return}this.__contentMetadata__.loadingAborter!==void 0&&this.__contentMetadata__.loadingAborter.abort(new Error("Could not load content due to an error")),this.__contentMetadata__.disposeMediaSource?.(),this.__contentMetadata__.stopPlaybackObservations?.(),this.__contentMetadata__.error=new Error("An error arised");break;case"content-warning":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring warning due to wrong `contentId`");return}break;case"content-info-update":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring warning due to wrong `contentId`");return}this.__contentMetadata__.minimumPosition=r.value.minimumPosition,this.__contentMetadata__.maximumPosition=r.value.maximumPosition;break;case"content-stopped":if(this.__contentMetadata__===null||this.__contentMetadata__.contentId!==r.value.contentId){console.info("API: Ignoring `content-stopped` due to wrong `contentId`");return}this.__contentMetadata__.disposeMediaSource?.(),this.__contentMetadata__.stopPlaybackObservations?.(),this.__contentMetadata__.loadingAborter?.abort(new Error("Content Stopped")),this.__contentMetadata__=null,this.trigger("stopped",null);break}},c.onerror=p=>{console.error("API: Worker Error encountered",p.error),f&&i(p.error)}}};function N(n,e,t,o){e.addEventListener("sourceclose",c),e.addEventListener("sourceended",i),e.addEventListener("sourceopen",f);let a=URL.createObjectURL(e);t.src=a;function i(){u(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:w.Ended}})}function f(){u(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:w.Open}})}function c(){u(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:w.Closed}})}return()=>{if(e.removeEventListener("sourceclose",c),e.removeEventListener("sourceended",i),e.removeEventListener("sourceopen",f),URL.revokeObjectURL(a),e.readyState!=="closed"){let{readyState:p,sourceBuffers:r}=e;for(let h=r.length-1;h>=0;h--){let s=r[h];if(!s.updating)try{p==="open"&&s.abort(),e.removeSourceBuffer(s)}catch{}}}t.src="",t.removeAttribute("src")}}var k=(i=>(i.Uninitialized="Uninitialized",i.Initializing="Initializing",i.Initialized="Initialized",i.Errored="errorred",i.Disposed="disposed",i))(k||{});function A(){}function U(n){let{textTracks:e}=n;if(e!=null){for(let t=0;t<e.length;t++)e[t].mode="disabled";if(n.hasChildNodes()){let{childNodes:t}=n;for(let o=t.length-1;o>=0;o--)if(t[o].nodeName==="track")try{n.removeChild(t[o])}catch{}}}n.src="",n.removeAttribute("src")}function v(n,e){return n instanceof Error?{message:n.message,name:n.name}:{message:e,name:void 0}}function R(n,e){return new Promise((t,o)=>{n.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA&&t(),e.addEventListener("abort",i),n.addEventListener("canplay",a);function a(){n.removeEventListener("canplay",a),e.removeEventListener("abort",i),t()}function i(){n.removeEventListener("canplay",a),e.removeEventListener("abort",i),e.reason!==null?o(e.reason):o(new Error("The loading operation was aborted"))}})}function O(n,e){n.stopPlaybackObservations?.(),n.loadingAborter?.abort(),e!==null&&u(e,{type:"stop",value:{contentId:n.contentId}})}var ke=E;})();
