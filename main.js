(()=>{function I(){let n="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(n+="0",e=0),n+String(e)}}var w=class{constructor(e){this._sourceBuffer=e,this._queue=[],this._pendingTask=null;let t=setInterval(()=>{this._flush()},2e3),o=this._onPendingTaskError.bind(this),s=()=>{this._flush()};e.addEventListener("error",o),e.addEventListener("updateend",s),this._dispose=[()=>{clearInterval(t),e.removeEventListener("error",o),e.removeEventListener("updateend",s)}]}push(e){return console.debug("QSB: receiving order to push data to the SourceBuffer"),this._addToQueue({type:0,value:e})}removeBuffer(e,t){return console.debug("QSB: receiving order to remove data from the SourceBuffer",e,t),this._addToQueue({type:1,value:{start:e,end:t}})}getBufferedRanges(){return this._sourceBuffer.buffered}dispose(){for(this._dispose.forEach(e=>e()),this._pendingTask!==null&&(this._pendingTask.reject(new Error("QueuedSourceBuffer Cancelled")),this._pendingTask=null);this._queue.length>0;){let e=this._queue.shift();e!==void 0&&e.reject(new Error("QueuedSourceBuffer Cancelled"))}}_onPendingTaskError(e){let t=e instanceof Error?e:new Error("An unknown error occured when doing operations on the SourceBuffer");this._pendingTask!=null&&this._pendingTask.reject(t)}_addToQueue(e){return new Promise((t,o)=>{let s=this._queue.length===0&&this._pendingTask===null,u={resolve:t,reject:o,...e};this._queue.push(u),s&&this._flush()})}_flush(){if(!this._sourceBuffer.updating){if(this._pendingTask!==null){let e=this._pendingTask,{resolve:t}=e;return this._pendingTask=null,t(),this._flush()}else{let e=this._queue.shift();if(e===void 0)return;this._pendingTask=e}try{switch(this._pendingTask.type){case 0:let e=this._pendingTask.value;if(e===void 0){this._flush();return}console.debug("QSB: pushing data"),this._sourceBuffer.appendBuffer(e);break;case 1:let{start:t,end:o}=this._pendingTask.value;console.debug("QSB: removing data from SourceBuffer",t,o),this._sourceBuffer.remove(t,o);break;default:j(this._pendingTask)}}catch(e){this._onPendingTaskError(e)}}}};function j(n){throw new Error("Unreachable path taken")}var O=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});O.decode();var E=new TextEncoder("utf-8"),N=typeof E.encodeInto=="function"?function(n,e){return E.encodeInto(n,e)}:function(n,e){let t=E.encode(n);return e.set(t),{read:n.length,written:t.length}};var L=Object.freeze({PlayerInstanceNotFound:1,1:"PlayerInstanceNotFound",NoMediaSourceAttached:2,2:"NoMediaSourceAttached",UnknownError:3,3:"UnknownError"}),z=Object.freeze({PlayerInstanceNotFound:1,1:"PlayerInstanceNotFound",NoMediaSourceAttached:2,2:"NoMediaSourceAttached",UnknownError:3,3:"UnknownError"}),R=Object.freeze({PlayerInstanceNotFound:1,1:"PlayerInstanceNotFound",UnknownError:2,2:"UnknownError"}),F=Object.freeze({PlayerOrSourceBufferInstanceNotFound:1,1:"PlayerOrSourceBufferInstanceNotFound",GivenResourceNotFound:2,2:"GivenResourceNotFound",UnknownError:3,3:"UnknownError"}),Q=Object.freeze({PlayerOrSourceBufferInstanceNotFound:1,1:"PlayerOrSourceBufferInstanceNotFound",UnknownError:2,2:"UnknownError"}),q=Object.freeze({PlayerInstanceNotFound:1,1:"PlayerInstanceNotFound",UnknownError:2,2:"UnknownError"}),D=Object.freeze({PlayerInstanceNotFound:0,0:"PlayerInstanceNotFound",NoMediaSourceAttached:1,1:"NoMediaSourceAttached",MediaSourceIsClosed:2,2:"MediaSourceIsClosed",QuotaExceededError:3,3:"QuotaExceededError",TypeNotSupportedError:4,4:"TypeNotSupportedError",EmptyMimeType:5,5:"EmptyMimeType",UnknownError:6,6:"UnknownError"}),H=Object.freeze({Init:0,0:"Init",Seeked:1,1:"Seeked",Seeking:2,2:"Seeking",ReadyStateChanged:3,3:"ReadyStateChanged",RegularInterval:4,4:"RegularInterval",Error:5,5:"Error"}),V=Object.freeze({Error:0,0:"Error",Warn:1,1:"Warn",Info:2,2:"Info",Debug:3,3:"Debug"}),G=Object.freeze({Audio:0,0:"Audio",Video:1,1:"Video"}),M=Object.freeze({Closed:0,0:"Closed",Ended:1,1:"Ended",Open:2,2:"Open"}),b=Object.freeze({Init:0,0:"Init",Seeking:1,1:"Seeking",Seeked:2,2:"Seeked",RegularInterval:3,3:"RegularInterval",LoadedData:4,4:"LoadedData",LoadedMetadata:5,5:"LoadedMetadata",CanPlay:6,6:"CanPlay",CanPlayThrough:7,7:"CanPlayThrough",Ended:8,8:"Ended",Pause:9,9:"Pause",Play:10,10:"Play",RateChange:11,11:"RateChange",Stalled:12,12:"Stalled"});var h=class extends Error{constructor(t,o,s){super();Object.setPrototypeOf(this,h.prototype),this.name="InitializationError",this.code=t,this.wasmHttpStatus=o,this.message=s}};var B=[["seeking",b.Seeking],["seeked",b.Seeked],["loadedmetadata",b.LoadedMetadata],["loadeddata",b.LoadedData],["canplay",b.CanPlay],["canplaythrough",b.CanPlayThrough],["ended",b.Ended],["pause",b.Pause],["play",b.Play],["ratechange",b.RateChange],["stalled",b.Stalled]];function C(n,e,t){let o=!1,s,u=B.map(([l,r])=>{n.addEventListener(l,g);function g(){i(r)}return()=>n.removeEventListener(l,g)});return Promise.resolve().then(()=>i(b.Init)),()=>{o||(o=!0,u.forEach(l=>l()),u.length=0,s!==void 0&&(clearTimeout(s),s=void 0))};function i(l){if(o)return;s!==void 0&&(clearTimeout(s),s=void 0);let r=new Float64Array(n.buffered.length*2);for(let p=0;p<n.buffered.length;p++){let _=p*2;r[_]=n.buffered.start(p),r[_+1]=n.buffered.end(p)}let{currentTime:g,readyState:a,paused:c,seeking:f}=n;t({mediaSourceId:e,reason:l,currentTime:g,readyState:a,buffered:r,paused:c,seeking:f}),s=setTimeout(()=>{if(o){s=void 0;return}i(b.RegularInterval)},1e3)}}function d(n,e,t){console.debug("--> sending to worker:",e.type),t===void 0?n.postMessage(e):n.postMessage(e,t)}var x=I(),y=class{constructor(e){this.videoElement=e,this.initializationStatus=S.Uninitialized,this._worker=null,this._currentContentMetadata=null}initialize(e){try{this.initializationStatus=S.Initializing;let{wasmUrl:t,workerUrl:o}=e,s=P,u=P,i=new Promise((l,r)=>{s=l,u=r});return this._startWorker(o,t,s,u),i}catch(t){return this.initializationStatus=S.Errored,Promise.reject(t)}}loadContent(e){if(this._worker===null)throw new Error("The Player is not initialized or disposed.");let t=x();this._currentContentMetadata={contentId:t,mediaSourceId:null,mediaSource:null,disposeMediaSource:null,sourceBuffers:[],stopPlaybackObservations:null},d(this._worker,{type:"load",value:{contentId:t,url:e}})}seek(e){this.videoElement.currentTime=e}stop(){if(this._worker===null)throw new Error("The Player is not initialized or disposed.");this._currentContentMetadata!==null&&this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),this._currentContentMetadata!==null&&d(this._worker,{type:"stop",value:{contentId:this._currentContentMetadata.contentId}})}dispose(){this._worker!==null&&(this._currentContentMetadata!==null&&this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),d(this._worker,{type:"dispose",value:null}),this._worker=null)}_startWorker(e,t,o,s){let u=!0,i=new Worker(e);this._worker=i,d(i,{type:"init",value:{hasWorkerMse:typeof MediaSource=="function"&&MediaSource.canConstructInDedicatedWorker===!0,wasmUrl:t}}),i.onmessage=l=>{let{data:r}=l;if(typeof r!="object"||r===null||typeof r.type!="string"){console.error("unexpected Worker message");return}switch(r.type){case"initialized":this.initializationStatus=S.Initialized,u=!1,o();break;case"initialization-error":if(u){let a=new h(r.value.code,r.value.wasmHttpStatus,r.value.message??"Error while initializing the WaspHlsPlayer");u=!1,s(a)}break;case"seek":if(this._currentContentMetadata===null||this._currentContentMetadata.mediaSourceId!==r.value.mediaSourceId){console.info("API: Ignoring seek due to wrong `mediaSourceId`");return}try{this.videoElement.currentTime=r.value.position}catch(a){console.error("Unexpected error while seeking:",a)}break;case"attach-media-source":if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==r.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}if(this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),r.value.handle!==void 0)this.videoElement.srcObject=r.value.handle;else if(r.value.src!==void 0)this.videoElement.src=r.value.src;else throw new Error('Unexpected "attach-media-source" message: missing source');this._currentContentMetadata.mediaSourceId=r.value.mediaSourceId,this._currentContentMetadata.mediaSource=null,this._currentContentMetadata.disposeMediaSource=()=>{r.value.src!==void 0&&URL.revokeObjectURL(r.value.src)},this._currentContentMetadata.sourceBuffers=[],this._currentContentMetadata.stopPlaybackObservations=null;break;case"create-media-source":{if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==r.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}let{mediaSourceId:a}=r.value,c;try{c=new MediaSource}catch(p){let{name:_,message:v}=m(p,"Unknown error when creating the MediaSource");d(i,{type:"create-media-source-error",value:{mediaSourceId:a,message:v,name:_}});return}let f=T(i,c,this.videoElement,a);this._currentContentMetadata.mediaSourceId=r.value.mediaSourceId,this._currentContentMetadata.mediaSource=c,this._currentContentMetadata.disposeMediaSource=f,this._currentContentMetadata.sourceBuffers=[],this._currentContentMetadata.stopPlaybackObservations=null;break}case"update-media-source-duration":{let{mediaSourceId:a}=r.value;if(this._currentContentMetadata?.mediaSourceId!==a||this._currentContentMetadata.mediaSource===null)return;try{this._currentContentMetadata.mediaSource.duration=r.value.duration}catch(c){let{name:f,message:p}=m(c,"Unknown error when updating the MediaSource's duration");d(i,{type:"update-media-source-duration-error",value:{mediaSourceId:a,message:p,name:f}});return}break}case"clear-media-source":{if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;try{this._currentContentMetadata.disposeMediaSource?.(),W(this.videoElement)}catch(a){console.warn("API: Error when clearing current MediaSource:",a)}break}case"create-source-buffer":{if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;if(this._currentContentMetadata.mediaSource===null){d(i,{type:"create-source-buffer-error",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{let a=this._currentContentMetadata.mediaSource.addSourceBuffer(r.value.contentType),c=new w(a);this._currentContentMetadata.sourceBuffers.push({sourceBufferId:r.value.sourceBufferId,queuedSourceBuffer:c})}catch(a){let{name:c,message:f}=m(a,"Unknown error when adding the SourceBuffer to the MediaSource");d(i,{type:"create-source-buffer-error",value:{mediaSourceId:r.value.mediaSourceId,sourceBufferId:r.value.sourceBufferId,code:1,message:f,name:c}})}break}case"append-buffer":{let p=function(_){let{name:v,message:k}=m(_,"Unknown error when appending data to the SourceBuffer");d(i,{type:"source-buffer-error",value:{sourceBufferId:f,message:k,name:v}})};if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;let a=this._currentContentMetadata.sourceBuffers.find(({sourceBufferId:_})=>_===r.value.sourceBufferId);if(a===void 0)return;let{mediaSourceId:c,sourceBufferId:f}=r.value;try{a.queuedSourceBuffer.push(r.value.data).then(()=>{d(i,{type:"source-buffer-updated",value:{mediaSourceId:c,sourceBufferId:f}})}).catch(p)}catch(_){p(_)}break}case"remove-buffer":{let p=function(_){let{name:v,message:k}=m(_,"Unknown error when removing data to the SourceBuffer");d(i,{type:"source-buffer-error",value:{sourceBufferId:f,message:k,name:v}})};if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;let a=this._currentContentMetadata.sourceBuffers.find(({sourceBufferId:_})=>_===r.value.sourceBufferId);if(a===void 0)return;let{mediaSourceId:c,sourceBufferId:f}=r.value;try{a.queuedSourceBuffer.removeBuffer(r.value.start,r.value.end).then(()=>{d(i,{type:"source-buffer-updated",value:{mediaSourceId:c,sourceBufferId:f}})}).catch(p)}catch(_){p(_)}break}case"start-playback-observation":{if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),this._currentContentMetadata.stopPlaybackObservations=C(this.videoElement,r.value.mediaSourceId,a=>d(i,{type:"observation",value:a}));break}case"stop-playback-observation":{if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null);break}case"end-of-stream":if(this._currentContentMetadata?.mediaSourceId!==r.value.mediaSourceId)return;let{mediaSourceId:g}=r.value;if(this._currentContentMetadata.mediaSource===null){d(i,{type:"end-of-stream-error",value:{mediaSourceId:g,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{this._currentContentMetadata.mediaSource.endOfStream()}catch(a){let{name:c,message:f}=m(a,"Unknown error when calling MediaSource.endOfStream()");d(i,{type:"end-of-stream-error",value:{mediaSourceId:g,code:1,message:f,name:c}})}break}},i.onerror=l=>{console.error("API: Worker Error encountered",l.error),u&&s(l.error)}}};function T(n,e,t,o){e.addEventListener("sourceclose",l),e.addEventListener("sourceended",u),e.addEventListener("sourceopen",i);let s=URL.createObjectURL(e);t.src=s;function u(){d(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:M.Ended}})}function i(){d(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:M.Open}})}function l(){d(n,{type:"media-source-state-changed",value:{mediaSourceId:o,state:M.Closed}})}return()=>{if(e.removeEventListener("sourceclose",l),e.removeEventListener("sourceended",u),e.removeEventListener("sourceopen",i),URL.revokeObjectURL(s),e.readyState!=="closed"){let{readyState:r,sourceBuffers:g}=e;for(let a=g.length-1;a>=0;a--){let c=g[a];if(!c.updating)try{r==="open"&&c.abort(),e.removeSourceBuffer(c)}catch{}}}t.src="",t.removeAttribute("src")}}var S=(u=>(u.Uninitialized="Uninitialized",u.Initializing="Initializing",u.Initialized="Initialized",u.Errored="errorred",u.Disposed="disposed",u))(S||{});function P(){}function W(n){let{textTracks:e}=n;if(e!=null){for(let t=0;t<e.length;t++)e[t].mode="disabled";if(n.hasChildNodes()){let{childNodes:t}=n;for(let o=t.length-1;o>=0;o--)if(t[o].nodeName==="track")try{n.removeChild(t[o])}catch{}}}n.src="",n.removeAttribute("src")}function m(n,e){return n instanceof Error?{message:n.message,name:n.name}:{message:e,name:void 0}}window.WaspHlsPlayer=y;var _e=y;})();
