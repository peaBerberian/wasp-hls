(()=>{function R(t){throw new Error("This function should never be called")}function b(){}var ke=0,q=class extends k{constructor(){super();this.error=b,this.warn=b,this.info=b,this.debug=b,this._currentLevel=ke}setLevel(r){let n=r<0||r>4?0:r;this._currentLevel=n,this.error=n>=1?console.error.bind(console):b,this.warn=n>=2?console.warn.bind(console):b,this.info=n>=3?console.info.bind(console):b,this.debug=n>=4?console.debug.bind(console):b,this.trigger("onLogLevelChange",n)}getLevel(){return this._currentLevel}hasLevel(r){return r>=this._currentLevel}},we=new q,i=we;var k=class{constructor(){this._listeners={}}addEventListener(e,r){let n=this._listeners[e];Array.isArray(n)?n.push(r):this._listeners[e]=[r]}removeEventListener(e,r){if(e===void 0){this._listeners={};return}let n=this._listeners[e];if(!Array.isArray(n))return;if(r===void 0){delete this._listeners[e];return}let a=n.indexOf(r);a!==-1&&n.splice(a,1),n.length===0&&delete this._listeners[e]}trigger(e,r){let n=this._listeners[e];!Array.isArray(n)||n.slice().forEach(a=>{try{a(r)}catch(s){i.error("EventEmitter: listener error",s instanceof Error?s:null)}})}};function N(){let t="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(t+="0",e=0),t+String(e)}}var Ee=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});Ee.decode();var He=new Uint8Array;var z=new TextEncoder("utf-8"),Fe=typeof z.encodeInto=="function"?function(t,e){return z.encodeInto(t,e)}:function(t,e){let r=z.encode(t);return e.set(r),{read:t.length,written:r.length}};var De=new Int32Array;var Qe=new Float64Array;var Ge=new Uint32Array;var $e=Object.freeze({MultiVariantPlaylist:0,0:"MultiVariantPlaylist",MediaPlaylist:1,1:"MediaPlaylist"}),T=Object.freeze({NoSupportedVariant:0,0:"NoSupportedVariant",UnfoundLockedVariant:1,1:"UnfoundLockedVariant",MediaSourceAttachmentError:2,2:"MediaSourceAttachmentError",Unknown:3,3:"Unknown"}),D=Object.freeze({AlreadyCreatedWithSameType:0,0:"AlreadyCreatedWithSameType",CantPlayType:1,1:"CantPlayType",EmptyMimeType:2,2:"EmptyMimeType",MediaSourceIsClosed:3,3:"MediaSourceIsClosed",NoMediaSourceAttached:4,4:"NoMediaSourceAttached",QuotaExceededError:5,5:"QuotaExceededError",Unknown:6,6:"Unknown"}),_=Object.freeze({Timeout:0,0:"Timeout",Status:1,1:"Status",Error:2,2:"Error",Other:3,3:"Other"}),Xe=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),Ye=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),Je=Object.freeze({UnknownError:0,0:"UnknownError",NoContentLoaded:1,1:"NoContentLoaded"}),Ke=Object.freeze({SourceBufferNotFound:0,0:"SourceBufferNotFound",UnknownError:1,1:"UnknownError"}),Ze=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),er=Object.freeze({MissingExtM3uHeader:0,0:"MissingExtM3uHeader",MultiVariantPlaylistWithoutVariant:1,1:"MultiVariantPlaylistWithoutVariant",MissingUriLineAfterVariant:2,2:"MissingUriLineAfterVariant",UnableToReadVariantUri:3,3:"UnableToReadVariantUri",VariantMissingBandwidth:4,4:"VariantMissingBandwidth",InvalidValue:5,5:"InvalidValue",MediaTagMissingType:6,6:"MediaTagMissingType",MediaTagMissingName:7,7:"MediaTagMissingName",MediaTagMissingGroupId:8,8:"MediaTagMissingGroupId",UnableToReadLine:9,9:"UnableToReadLine",Unknown:10,10:"Unknown"}),rr=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",MediaSourceIsClosed:1,1:"MediaSourceIsClosed",QuotaExceededError:2,2:"QuotaExceededError",TypeNotSupportedError:3,3:"TypeNotSupportedError",EmptyMimeType:4,4:"EmptyMimeType",UnknownError:5,5:"UnknownError"}),tr=Object.freeze({NoResource:0,0:"NoResource",NoSourceBuffer:1,1:"NoSourceBuffer",TransmuxerError:2,2:"TransmuxerError",UnknownError:3,3:"UnknownError"}),nr=Object.freeze({Init:0,0:"Init",Seeked:1,1:"Seeked",Seeking:2,2:"Seeking",Ended:3,3:"Ended",ReadyStateChanged:4,4:"ReadyStateChanged",RegularInterval:5,5:"RegularInterval",Error:6,6:"Error"}),ar=Object.freeze({MediaPlaylistRefresh:0,0:"MediaPlaylistRefresh",RetryRequest:1,1:"RetryRequest"}),or=Object.freeze({Error:0,0:"Error",Warn:1,1:"Warn",Info:2,2:"Info",Debug:3,3:"Debug"}),w=Object.freeze({Audio:0,0:"Audio",Video:1,1:"Video"}),U=Object.freeze({Closed:0,0:"Closed",Ended:1,1:"Ended",Open:2,2:"Open"}),m=Object.freeze({Init:0,0:"Init",RegularInterval:1,1:"RegularInterval",Seeking:2,2:"Seeking",Seeked:3,3:"Seeked",LoadedData:4,4:"LoadedData",LoadedMetadata:5,5:"LoadedMetadata",CanPlay:6,6:"CanPlay",CanPlayThrough:7,7:"CanPlayThrough",Ended:8,8:"Ended",Pause:9,9:"Pause",Play:10,10:"Play",RateChange:11,11:"RateChange",Stalled:12,12:"Stalled"});var l={AlreadyInitializedError:"AlreadyInitializedError",WasmRequestError:"WasmRequestError",UnknownInitializationError:"UnknownInitializationError",SegmentBadHttpStatus:"SegmentBadHttpStatus",SegmentRequestTimeout:"SegmentRequestTimeout",SegmentRequestError:"SegmentRequestError",SegmentRequestOtherError:"SegmentRequestOtherError",MultiVariantPlaylistBadHttpStatus:"MultiVariantPlaylistBadHttpStatus",MultiVariantPlaylistRequestTimeout:"MultiVariantPlaylistRequestTimeout",MultiVariantPlaylistRequestError:"MultiVariantPlaylistRequestError",MultiVariantPlaylistRequestOtherError:"MultiVariantPlaylistRequestOtherError",MediaPlaylistBadHttpStatus:"MediaPlaylistBadHttpStatus",MediaPlaylistRequestTimeout:"MediaPlaylistRequestTimeout",MediaPlaylistRequestError:"MediaPlaylistRequestError",MediaPlaylistRequestOtherError:"MediaPlaylistRequestOtherError",MediaSourceAttachmentError:"MediaSourceAttachmentError",NoSupportedVariant:"NoSupportedVariant",UnfoundLockedVariant:"UnfoundLockedVariant",Unknown:"Unknown",SourceBufferCantPlayType:"SourceBufferCantPlayType",SourceBufferCreationOtherError:"SourceBufferCreationOtherError",MultiVariantPlaylistMissingExtM3uHeader:"MultiVariantPlaylistMissingExtM3uHeader",MultiVariantPlaylistWithoutVariant:"MultiVariantPlaylistWithoutVariant",MultiVariantPlaylistMissingUriLineAfterVariant:"MultiVariantPlaylistMissingUriLineAfterVariant",MultiVariantPlaylistVariantMissingBandwidth:"MultiVariantPlaylistVariantMissingBandwidth",MultiVariantPlaylistInvalidValue:"MultiVariantPlaylistInvalidValue",MultiVariantPlaylistMediaTagMissingType:"MultiVariantPlaylistMediaTagMissingType",MultiVariantPlaylistMediaTagMissingName:"MultiVariantPlaylistMediaTagMissingName",MultiVariantPlaylistMediaTagMissingGroupId:"MultiVariantPlaylistMediaTagMissingGroupId",MultiVariantPlaylistOtherError:"MultiVariantPlaylistOtherError",SegmentTransmuxingError:"SegmentTransmuxingError",SegmentParsingOtherError:"SegmentParsingOtherError",SourceBufferQuotaExceededError:"SourceBufferQuotaExceededError",SourceBufferOtherError:"SourceBufferOtherError"};var y=class extends Error{constructor(r,n,a){super();switch(Object.setPrototypeOf(this,y.prototype),this.name="WaspInitializationError",r){case 0:this.code=l.AlreadyInitializedError;break;case 1:this.code=l.WasmRequestError;break;case 2:this.code=l.UnknownInitializationError;break}this.globalCode=this.code,this.wasmHttpStatus=n,this.message=a}};var P=class extends Error{constructor(r,n){super();Object.setPrototypeOf(this,P.prototype),this.name="WaspMediaPlaylistParsingError",this.code="Unknown",this.globalCode=this.code,this.mediaType=r,this.message=n??"Unknown error when parsing a Media Playlist"}};var x=class extends Error{constructor(r,n,a,s){super();Object.setPrototypeOf(this,x.prototype),this.name="WaspMediaPlaylistRequestError",this.url=r;let o=s;switch(n){case _.Status:o=o??(a===void 0?"A Media Playlist HTTP(S) request(s) responded with an invalid status":`A Media Playlist HTTP(S) request(s) " +
            "responded with a ${a} status`),this.code=l.MediaPlaylistBadHttpStatus;break;case _.Timeout:o=o??"A Media Playlist HTTP(S) request(s) did not respond",this.code=l.MediaPlaylistRequestTimeout;break;case _.Error:o=o??"A Media Playlist HTTP(S) request(s) failed due to an error.",this.code=l.MediaPlaylistRequestError;break;case _.Other:o=o??"A Media Playlist HTTP(S) request(s) failed for an unknown reason.",this.code=l.MediaPlaylistRequestOtherError;break;default:this.code=l.MediaPlaylistRequestOtherError;break}this.globalCode=this.code,this.message=o??"An error arised while trying to perform a segment request"}};var M=class extends Error{constructor(r,n){super();switch(Object.setPrototypeOf(this,M.prototype),r){case 0:this.code="MultiVariantPlaylistMissingExtM3uHeader";break;case 1:this.code="MultiVariantPlaylistWithoutVariant";break;case 2:this.code="MultiVariantPlaylistMissingUriLineAfterVariant";break;case 4:this.code="MultiVariantPlaylistVariantMissingBandwidth";break;case 5:this.code="MultiVariantPlaylistInvalidValue";break;case 6:this.code="MultiVariantPlaylistMediaTagMissingType";break;case 7:this.code="MultiVariantPlaylistMediaTagMissingName";break;case 8:this.code="MultiVariantPlaylistMediaTagMissingGroupId";break;case 10:this.code="MultiVariantPlaylistOtherError";break;default:this.code="MultiVariantPlaylistOtherError";break}this.globalCode=this.code,this.name="WaspMultiVariantPlaylistParsingError",this.message=n??"Unknown error when parsing the MultiVariant Playlist"}};var W=class extends Error{constructor(r,n,a,s){super();Object.setPrototypeOf(this,W.prototype),this.name="WaspMultiVariantPlaylistRequestError",this.url=r;let o=s;switch(n){case _.Status:o=o??(a===void 0?"A MultiVariant Playlist HTTP(S) request(s) responded with an invalid status":`A MultiVariant Playlist HTTP(S) request(s) " +
            "responded with a ${a} status`),this.code=l.MultiVariantPlaylistBadHttpStatus;break;case _.Timeout:o=o??"A MultiVariant Playlist HTTP(S) request(s) did not respond",this.code=l.MultiVariantPlaylistRequestTimeout;break;case _.Error:o=o??"A MultiVariant Playlist HTTP(S) request(s) failed due to an error.",this.code=l.MultiVariantPlaylistRequestError;break;case _.Other:o=o??"A MultiVariant Playlist HTTP(S) request(s) failed for an unknown reason.",this.code=l.MultiVariantPlaylistRequestOtherError;break;default:this.code=l.MultiVariantPlaylistRequestOtherError;break}this.globalCode=this.code,this.message=o??"An error arised while trying to perform a segment request"}};var h=class extends Error{constructor(r,n){super();switch(Object.setPrototypeOf(this,h.prototype),this.name="WaspOtherError",r){case T.MediaSourceAttachmentError:this.code=l.MediaSourceAttachmentError;break;case T.UnfoundLockedVariant:this.code=l.UnfoundLockedVariant;break;case T.NoSupportedVariant:this.code=l.NoSupportedVariant;break;default:this.code=l.Unknown;break}this.globalCode=this.code,this.message=n??"Unknown error"}};var A=class extends Error{constructor(r,n){super();Object.setPrototypeOf(this,A.prototype),this.name="WaspSegmentParsingError",this.code="SegmentParsingOtherError",this.globalCode=this.code,this.mediaType=r,this.message=n??"Unknown error when parsing a segment"}};var v=class extends Error{constructor(r,n){super();Object.setPrototypeOf(this,v.prototype),this.name="WaspSegmentRequestError",this.url=r.url,this.isInit=r.isInit;let a=n,{mediaType:s}=r,o=Ie(s)+" segment";switch(r.reason){case _.Status:a=a??(r.status===void 0?`${o}'s HTTP(S) request(s) responded with an invalid status`:`${o}'s HTTP(S) request(s) responded with a ${r.status} status`),this.code=l.SegmentBadHttpStatus;break;case _.Timeout:a=a??`${o}'s HTTP(S) request(s) did not respond`,this.code=l.SegmentRequestTimeout;break;case _.Error:a=a??`${o}'s HTTP(S) request(s) failed due to an error.`,this.code=l.SegmentRequestError;break;case _.Other:a=a??`${o}'s HTTP(S) request(s) failed for an unknown reason.`,this.code=l.SegmentRequestOtherError;break;default:this.code=l.SegmentRequestOtherError;break}this.globalCode=this.code,this.message=a??"An error arised while trying to perform a segment request"}};function Ie(t){switch(t){case w.Audio:return"An audio";case w.Video:return"A video"}throw new Error("Unknown MediaType")}var S=class extends Error{constructor(r,n){super();switch(Object.setPrototypeOf(this,S.prototype),this.name="WaspSourceBufferCreationError",r){case D.CantPlayType:this.code="SourceBufferCantPlayType";break;default:this.code="SourceBufferCreationOtherError"}this.globalCode=this.code,this.message=n??"Unknown error when creating SourceBuffer"}};var L=class extends Error{constructor(r){super();Object.setPrototypeOf(this,L.prototype),this.name="WaspSourceBufferError",this.code="SourceBufferOtherError",this.globalCode=this.code,this.message=r??"Unknown error"}};function c(t,e,r){i.debug("--> sending to worker:",e.type),r===void 0?t.postMessage(e):t.postMessage(e,r)}var H=(a=>(a.Stopped="Stopped",a.Loading="Loading",a.Loaded="Loaded",a.Error="Error",a))(H||{});var Te='video/mp2t;codecs="avc1.4D401F"',Pe=navigator.userAgent.toLowerCase().indexOf("firefox")!==-1;function G(){return Pe?!1:typeof MediaSource=="function"&&MediaSource.isTypeSupported(Te)}function E(t,e){return t instanceof Error?{message:t.message,name:t.name}:{message:e,name:void 0}}function B(t,e){t.stopPlaybackObservations?.(),t.loadingAborter?.abort(),e!==null&&c(e,{type:"stop",value:{contentId:t.contentId}})}function $(t,e){return new Promise((r,n)=>{t.readyState>=HTMLMediaElement.HAVE_ENOUGH_DATA&&r(),e.addEventListener("abort",s),t.addEventListener("canplay",a);function a(){t.removeEventListener("canplay",a),e.removeEventListener("abort",s),r()}function s(){t.removeEventListener("canplay",a),e.removeEventListener("abort",s),e.reason!==null?n(e.reason):n(new Error("The loading operation was aborted"))}})}function X(t){let{textTracks:e}=t;if(e!=null){for(let r=0;r<e.length;r++)e[r].mode="disabled";if(t.hasChildNodes()){let{childNodes:r}=t;for(let n=r.length-1;n>=0;n--)if(r[n].nodeName==="track")try{t.removeChild(r[n])}catch(a){let s=a instanceof Error?a.toString():"Unknown Error";i.warn("Unable to remove track element from media element",s)}}}t.src="",t.removeAttribute("src")}var C=class{constructor(e){this._sourceBuffer=e,this._queue=[],this._pendingTask=null;let r=setInterval(()=>{this._flush()},2e3),n=this._onPendingTaskError.bind(this),a=()=>{this._flush()};e.addEventListener("error",n),e.addEventListener("updateend",a),this._dispose=[()=>{clearInterval(r),e.removeEventListener("error",n),e.removeEventListener("updateend",a)}]}push(e){return i.debug("QSB: receiving order to push data to the SourceBuffer"),this._addToQueue({type:0,value:e})}removeBuffer(e,r){return i.debug("QSB: receiving order to remove data from the SourceBuffer",e,r),this._addToQueue({type:1,value:{start:e,end:r}})}getBufferedRanges(){return this._sourceBuffer.buffered}dispose(){for(this._dispose.forEach(e=>e()),this._pendingTask!==null&&(this._pendingTask.reject(new Error("QueuedSourceBuffer Cancelled")),this._pendingTask=null);this._queue.length>0;){let e=this._queue.shift();e!==void 0&&e.reject(new Error("QueuedSourceBuffer Cancelled"))}}_onPendingTaskError(e){let r=e instanceof Error?e:new Error("An unknown error occured when doing operations on the SourceBuffer");this._pendingTask!=null&&this._pendingTask.reject(r)}_addToQueue(e){return new Promise((r,n)=>{let a=this._queue.length===0&&this._pendingTask===null,s={resolve:r,reject:n,...e};this._queue.push(s),a&&this._flush()})}_flush(){if(!this._sourceBuffer.updating){if(this._pendingTask!==null){let e=this._pendingTask,{resolve:r}=e;return this._pendingTask=null,r(),this._flush()}else{let e=this._queue.shift();if(e===void 0)return;this._pendingTask=e}try{switch(this._pendingTask.type){case 0:let e=this._pendingTask.value;if(e===void 0){this._flush();return}i.debug("QSB: pushing data"),this._sourceBuffer.appendBuffer(e);break;case 1:let{start:r,end:n}=this._pendingTask.value;i.debug("QSB: removing data from SourceBuffer",r,n),this._sourceBuffer.remove(r,n);break;default:xe(this._pendingTask)}}catch(e){this._onPendingTaskError(e)}}}};function xe(t){throw new Error("Unreachable path taken")}function I(t){let e=new Float64Array(t.length*2);for(let r=0;r<t.length;r++){let n=r*2;e[n]=t.start(r),e[n+1]=t.end(r)}return e}var We=[["seeking",m.Seeking],["seeked",m.Seeked],["loadedmetadata",m.LoadedMetadata],["loadeddata",m.LoadedData],["canplay",m.CanPlay],["canplaythrough",m.CanPlayThrough],["ended",m.Ended],["pause",m.Pause],["play",m.Play],["ratechange",m.RateChange],["stalled",m.Stalled]];function F(t,e,r){let n=!1,a,s=We.map(([d,p])=>{t.addEventListener(d,f);function f(){o(p)}return()=>t.removeEventListener(d,f)});return Promise.resolve().then(()=>o(m.Init)),()=>{n||(n=!0,s.forEach(d=>d()),s.length=0,a!==void 0&&(clearTimeout(a),a=void 0))};function o(d){if(n)return;a!==void 0&&(clearTimeout(a),a=void 0);let p=I(t.buffered),{currentTime:f,readyState:u,paused:g,seeking:O,ended:j,duration:Se}=t;r({mediaSourceId:e,reason:d,currentTime:f,readyState:u,buffered:p,paused:g,seeking:O,ended:j,duration:Se}),a=window.setTimeout(()=>{if(n){a=void 0;return}o(m.RegularInterval)},1e3)}}function Y(t,e,r){if(e?.contentId!==t.value.contentId){i.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}if(e.stopPlaybackObservations!==null&&(e.stopPlaybackObservations(),e.stopPlaybackObservations=null),t.value.handle!==void 0)r.srcObject=t.value.handle;else if(t.value.src!==void 0)r.src=t.value.src;else throw new Error('Unexpected "attach-media-source" message: missing source');e.mediaSourceId=t.value.mediaSourceId,e.mediaSource=null,e.disposeMediaSource=()=>{t.value.src!==void 0&&URL.revokeObjectURL(t.value.src)},e.sourceBuffers=[],e.stopPlaybackObservations=null}function J(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring seek due to wrong `mediaSourceId`");return}try{r.currentTime=t.value.position}catch(n){let a=n instanceof Error?n:"Unknown Error";i.error("Unexpected error while seeking:",a)}}function K(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring flush due to wrong `mediaSourceId`");return}try{r.currentTime=r.currentTime-.001}catch(n){let a=n instanceof Error?n:"Unknown Error";i.error("Unexpected error while flushing:",a)}}function Z(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring playback rate update due to wrong `mediaSourceId`");return}try{r.playbackRate=t.value.playbackRate}catch(n){let a=n instanceof Error?n:"Unknown Error";i.error("Unexpected error while changing the playback rate:",a)}}function ee(t,e,r,n){if(e?.contentId!==t.value.contentId)i.info("API: Ignoring MediaSource attachment due to wrong `contentId`");else{let{mediaSourceId:a}=t.value;try{e.disposeMediaSource?.(),e.stopPlaybackObservations?.();let s=new MediaSource,o=Ae(n,s,r,a);e.mediaSourceId=t.value.mediaSourceId,e.mediaSource=s,e.disposeMediaSource=o,e.sourceBuffers=[],e.stopPlaybackObservations=null}catch(s){let{name:o,message:d}=E(s,"Unknown error when creating the MediaSource");c(n,{type:"create-ms",value:{mediaSourceId:a,message:d,name:o}})}}}function re(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring duration update due to wrong `mediaSourceId`");return}try{e.mediaSource===null?i.info("API: Ignoring duration update due to no MediaSource"):e.mediaSource.duration=t.value.duration}catch(n){let{name:a,message:s}=E(n,"Unknown error when updating the MediaSource's duration"),{mediaSourceId:o}=t.value;c(r,{type:"update-ms-dur-err",value:{mediaSourceId:o,message:s,name:a}})}}function te(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring MediaSource clearing due to wrong `mediaSourceId`");return}try{e.disposeMediaSource?.(),X(r)}catch(n){let a=n instanceof Error?n:"Unknown Error";i.warn("API: Error when clearing current MediaSource:",a)}}function ne(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring SourceBuffer creation due to wrong `mediaSourceId`");return}if(e.mediaSource===null){c(r,{type:"create-sb",value:{mediaSourceId:t.value.mediaSourceId,sourceBufferId:t.value.sourceBufferId,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{let n=e.mediaSource.addSourceBuffer(t.value.contentType),a=new C(n);e.sourceBuffers.push({sourceBufferId:t.value.sourceBufferId,queuedSourceBuffer:a})}catch(n){let{name:a,message:s}=E(n,"Unknown error when adding the SourceBuffer to the MediaSource");c(r,{type:"create-sb",value:{mediaSourceId:t.value.mediaSourceId,sourceBufferId:t.value.sourceBufferId,code:1,message:s,name:a}})}}function ae(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring appendBuffer operation due to wrong `mediaSourceId`");return}let n=e.sourceBuffers.find(({sourceBufferId:a})=>a===t.value.sourceBufferId);if(n!==void 0){let o=function(d){let{name:p,message:f}=E(d,"Unknown error when appending data to the SourceBuffer");c(r,{type:"sb-err",value:{mediaSourceId:a,sourceBufferId:s,message:f,name:p}})},{mediaSourceId:a,sourceBufferId:s}=t.value;try{n.queuedSourceBuffer.push(t.value.data).then(()=>{let d=n.queuedSourceBuffer.getBufferedRanges();c(r,{type:"sb-s",value:{mediaSourceId:a,sourceBufferId:s,buffered:I(d)}})}).catch(o)}catch(d){o(d)}}}function oe(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring removeBuffer operation due to wrong `mediaSourceId`");return}let n=e.sourceBuffers.find(({sourceBufferId:a})=>a===t.value.sourceBufferId);if(n!==void 0){let o=function(d){let{name:p,message:f}=E(d,"Unknown error when removing data to the SourceBuffer");c(r,{type:"sb-err",value:{mediaSourceId:a,sourceBufferId:s,message:f,name:p}})},{mediaSourceId:a,sourceBufferId:s}=t.value;try{n.queuedSourceBuffer.removeBuffer(t.value.start,t.value.end).then(()=>{let d=n.queuedSourceBuffer.getBufferedRanges();c(r,{type:"sb-s",value:{mediaSourceId:a,sourceBufferId:s,buffered:I(d)}})}).catch(o)}catch(d){o(d)}}}function ie(t,e,r,n){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring `start-playback-observation` due to wrong `mediaSourceId`");return}e.stopPlaybackObservations!==null&&(e.stopPlaybackObservations(),e.stopPlaybackObservations=null),e.stopPlaybackObservations=F(r,t.value.mediaSourceId,a=>{let s={};for(let o of e.sourceBuffers){let d=o.queuedSourceBuffer.getBufferedRanges(),p=I(d);s[o.sourceBufferId]=p}c(n,{type:"obs",value:Object.assign(a,{sourceBuffersBuffered:s})})})}function se(t,e){if(e?.mediaSourceId!==t.value.mediaSourceId){i.info("API: Ignoring `stop-playback-observation` due to wrong `mediaSourceId`");return}e.stopPlaybackObservations!==null&&(e.stopPlaybackObservations(),e.stopPlaybackObservations=null)}function ue(t,e,r){if(e?.mediaSourceId!==t.value.mediaSourceId)i.info("API: Ignoring `end-of-stream` due to wrong `mediaSourceId`");else{let{mediaSourceId:n}=t.value;if(e.mediaSource===null){c(r,{type:"eos-err",value:{mediaSourceId:n,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}if(e.mediaSource.readyState==="ended"){i.info("Ignoring redundant end-of-stream order");return}try{e.mediaSource.endOfStream()}catch(a){let{name:s,message:o}=E(a,"Unknown error when calling MediaSource.endOfStream()");c(r,{type:"eos-err",value:{mediaSourceId:n,code:1,message:o,name:s}})}}}function de(t,e){if(e?.contentId!==t.value.contentId){i.info("API: Ignoring media offset update due to wrong `contentId`");return}e.mediaOffset=t.value.offset}function ce(t,e,r){return e?.mediaSourceId!==t.value.mediaSourceId?(i.info("API: Ignoring rebuffering start due to wrong `mediaSourceId`"),!1):(t.value.updatePlaybackRate&&(r.playbackRate=0),e.isRebuffering?!1:(e.isRebuffering=!0,!0))}function le(t,e,r){return e?.mediaSourceId!==t.value.mediaSourceId?(i.info("API: Ignoring rebuffering end due to wrong `mediaSourceId`"),!1):(r.playbackRate===0&&e.wantedSpeed!==0&&(r.playbackRate=e.wantedSpeed),e.isRebuffering?(e.isRebuffering=!1,!0):!1)}function fe(t,e){if(e?.contentId!==t.value.contentId)return i.info("API: Ignoring error due to wrong `contentId`"),null;e.loadingAborter!==void 0&&e.loadingAborter.abort(new Error("Could not load content due to an error")),e.disposeMediaSource?.(),e.stopPlaybackObservations?.();let r=pe(t);return e.error=r,r}function pe(t){switch(t.value.errorInfo.type){case"segment-request":return new v(t.value.errorInfo.value,t.value.message);case"other-error":return new h(t.value.errorInfo.value.code,t.value.message);case"source-buffer-creation-error":return new S(t.value.errorInfo.value.code,t.value.message);case"multi-var-playlist-parse":return new M(t.value.errorInfo.value.code,t.value.message);default:return new h(T.Unknown,t.value.message??"An error arised")}}function _e(t,e){return e?.contentId!==t.value.contentId?(i.info("API: Ignoring warning due to wrong `contentId`"),null):pe(t)}function me(t,e){if(e?.contentId!==t.value.contentId){i.info("API: Ignoring warning due to wrong `contentId`");return}e.minimumPosition=t.value.minimumPosition,e.maximumPosition=t.value.maximumPosition}function ge(t,e){return e?.contentId!==t.value.contentId?(i.info("API: Ignoring warning due to wrong `contentId`"),!1):(e.variants=t.value.variants,e.audioTracks=t.value.audioTracks,!0)}function be(t,e){return e?.contentId!==t.value.contentId?(i.info("API: Ignoring warning due to wrong `contentId`"),!1):t.value.mediaType!==w.Audio?(i.warn("API: track update for a type not handled for now"),!1):(e.currentAudioTrack=t.value.audioTrack?{id:t.value.audioTrack.current,isSelected:t.value.audioTrack.isSelected}:void 0,!0)}function he(t,e){if(e?.contentId!==t.value.contentId)return i.info("API: Ignoring warning due to wrong `contentId`"),!1;let r=e.variants.find(n=>n.id===t.value.variantId);return r===void 0&&i.warn("API: VariantUpdate for an unfound variant"),r!==e.currVariant?(e.currVariant=r,!0):!1}function ye(t,e){if(e?.contentId!==t.value.contentId)return i.info("API: Ignoring warning due to wrong `contentId`"),!1;if(t.value.lockedVariant===null)return e.lockedVariant!==null?(e.lockedVariant=null,!0):!1;let r=e.variants.find(n=>n.id===t.value.lockedVariant);return r===void 0?(i.warn("API: VariantLockStatusChange for an unfound variant"),e.lockedVariant!==null?(e.lockedVariant=null,!0):!1):r!==e.lockedVariant?(e.lockedVariant=r,!0):!1}function Me(t,e){return e?.contentId!==t.value.contentId?(i.info("API: Ignoring `content-stopped` due to wrong `contentId`"),!1):(e.disposeMediaSource?.(),e.stopPlaybackObservations?.(),e.loadingAborter?.abort(new Error("Content Stopped")),!0)}function Ae(t,e,r,n){e.addEventListener("sourceclose",d),e.addEventListener("sourceended",s),e.addEventListener("sourceopen",o);let a=URL.createObjectURL(e);r.src=a;function s(){c(t,{type:"ms-state",value:{mediaSourceId:n,state:U.Ended}})}function o(){c(t,{type:"ms-state",value:{mediaSourceId:n,state:U.Open}})}function d(){c(t,{type:"ms-state",value:{mediaSourceId:n,state:U.Closed}})}return()=>{if(e.removeEventListener("sourceclose",d),e.removeEventListener("sourceended",s),e.removeEventListener("sourceopen",o),URL.revokeObjectURL(a),e.readyState!=="closed"){let{readyState:p,sourceBuffers:f}=e;for(let u=f.length-1;u>=0;u--){let g=f[u];if(!g.updating)try{p==="open"&&g.abort(),e.removeSourceBuffer(g)}catch(O){let j=O instanceof Error?O:"Unknown Error";i.warn("Could not remove SourceBuffer",j)}}}r.src="",r.removeAttribute("src")}}function ve(t,e){let r={};for(let n of t.value.mimeTypes)r[n]=MediaSource.isTypeSupported(n);c(e,{type:"codecs-support-upd",value:{mimeTypes:r}})}var Le=N();var Ue={bufferGoal:15,segmentRequestTimeout:2e4,segmentBackoffBase:300,segmentBackoffMax:2e3,multiVariantPlaylistRequestTimeout:15e3,multiVariantPlaylistBackoffBase:300,multiVariantPlaylistBackoffMax:2e3,mediaPlaylistRequestTimeout:15e3,mediaPlaylistBackoffBase:300,mediaPlaylistBackoffMax:2e3},V=class extends k{constructor(r,n){super();this.videoElement=r,this.initializationStatus="Uninitialized",this.__worker__=null,this.__contentMetadata__=null,this.__logLevelChangeListener__=null,this.__destroyAbortController__=new AbortController,this.__config__={...Ue,...n??{}};let a=()=>{this.getPlayerState()==="Loaded"&&this.trigger("paused",null)},s=()=>{this.getPlayerState()==="Loaded"&&this.trigger("ended",null)},o=()=>{this.getPlayerState()==="Loaded"&&this.__contentMetadata__!==null&&this.trigger("playing",null)};this.videoElement.addEventListener("pause",a),this.videoElement.addEventListener("play",o),this.videoElement.addEventListener("ended",s),this.__destroyAbortController__.signal.addEventListener("abort",()=>{this.videoElement.removeEventListener("pause",a),this.videoElement.removeEventListener("play",o),this.videoElement.removeEventListener("ended",s)})}initialize(r){try{if(this.initializationStatus!=="Uninitialized")throw new Error("WaspHlsPlayer already initialized");this.initializationStatus="Initializing";let{wasmUrl:n,workerUrl:a}=r,s=b,o=b,d=new Promise((p,f)=>{s=p,o=f});return this.__startWorker__(a,n,s,o),d}catch(n){return this.initializationStatus="errored",Promise.reject(n)}}getConfig(){return this.__config__}updateConfig(r){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__config__={...this.__config__,...r},c(this.__worker__,{type:"upd-conf",value:this.__config__})}load(r){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&B(this.__contentMetadata__,this.__worker__);let n=Le(),a=new AbortController;this.__contentMetadata__={contentId:n,mediaSourceId:null,mediaSource:null,disposeMediaSource:null,sourceBuffers:[],variants:[],audioTracks:[],currentAudioTrack:void 0,currVariant:void 0,lockedVariant:null,stopPlaybackObservations:null,isRebuffering:!1,mediaOffset:void 0,wantedSpeed:1,minimumPosition:void 0,maximumPosition:void 0,loadingAborter:a,error:null},this.trigger("playerStateChange","Loading"),c(this.__worker__,{type:"load",value:{contentId:n,url:r}})}getPlayerState(){return this.__contentMetadata__===null?"Stopped":this.__contentMetadata__.error!==null?"Error":this.__contentMetadata__.loadingAborter!==void 0?"Loading":"Loaded"}getPosition(){return this.__contentMetadata__===null?0:this.videoElement.currentTime-(this.__contentMetadata__.mediaOffset??0)}seek(r){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot seek: no content loaded.");this.videoElement.currentTime=r+(this.__contentMetadata__?.mediaOffset??0)}getMediaOffset(){return this.__contentMetadata__?.mediaOffset??void 0}setVolume(r){this.videoElement.volume=r}isPlaying(){return this.getPlayerState()==="Loaded"&&!this.videoElement.paused}isPaused(){return this.videoElement.paused}isEnded(){return this.videoElement.ended}isRebuffering(){return this.__contentMetadata__?.isRebuffering??!1}pause(){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot pause: no content loaded.");this.videoElement.pause()}resume(){if(this.getPlayerState()!=="Loaded")throw new Error("Cannot resume: no content loaded.");this.videoElement.play().catch(()=>{})}stop(){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");this.__contentMetadata__!==null&&B(this.__contentMetadata__,this.__worker__)}setSpeed(r){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null||this.__contentMetadata__.mediaSourceId===null)throw new Error("No content is loaded");this.__contentMetadata__.wantedSpeed=r,c(this.__worker__,{type:"upd-speed",value:{mediaSourceId:this.__contentMetadata__.mediaSourceId,wantedSpeed:r}})}getSpeed(){return this.__contentMetadata__?.wantedSpeed??1}getMinimumPosition(){return this.__contentMetadata__?.minimumPosition}getMaximumPosition(){return this.__contentMetadata__?.maximumPosition}getError(){return this.__contentMetadata__?.error??null}getCurrentVariant(){return this.__contentMetadata__?.currVariant??void 0}getVariantList(){return this.__contentMetadata__?.variants??[]}getAudioTrackList(){return this.__contentMetadata__?.audioTracks??[]}getAudioTrack(){let r=this.__contentMetadata__?.currentAudioTrack?.id;if(r!==void 0)return this.getAudioTrackList()?.find(n=>n.id===r)}setAudioTrack(r){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");c(this.__worker__,{type:"set-audio",value:{contentId:this.__contentMetadata__.contentId,trackId:r}})}lockVariant(r){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");c(this.__worker__,{type:"lock-var",value:{contentId:this.__contentMetadata__.contentId,variantId:r}})}unlockVariant(){if(this.__worker__===null)throw new Error("The Player is not initialized or disposed.");if(this.__contentMetadata__===null)throw new Error("No content loaded");c(this.__worker__,{type:"lock-var",value:{contentId:this.__contentMetadata__.contentId,variantId:null}})}getLockedVariant(){return this.__contentMetadata__?.lockedVariant??null}dispose(){this.__destroyAbortController__.abort(),this.__worker__!==null&&(this.__contentMetadata__!==null&&B(this.__contentMetadata__,this.__worker__),c(this.__worker__,{type:"dispose",value:null}),this.__worker__=null,this.__logLevelChangeListener__!==null&&i.removeEventListener("onLogLevelChange",this.__logLevelChangeListener__),this.videoElement.src="")}__startWorker__(r,n,a,s){let o=!0,d=new Worker(r);this.__worker__=d,c(d,{type:"init",value:{hasMseInWorker:typeof MediaSource=="function"&&MediaSource.canConstructInDedicatedWorker===!0,canDemuxMpeg2Ts:G(),wasmUrl:n,logLevel:i.getLevel(),initialConfig:this.__config__}}),this.__logLevelChangeListener__!==null&&i.removeEventListener("onLogLevelChange",this.__logLevelChangeListener__),i.addEventListener("onLogLevelChange",p),this.__logLevelChangeListener__=p,d.onmessage=f=>{let{data:u}=f;if(typeof u!="object"||u===null||typeof u.type>"u"){i.error("unexpected Worker message");return}switch(u.type){case"init":this.initializationStatus="Initialized",o=!1,a();break;case"init-err":if(o){let g=new y(u.value.code,u.value.wasmHttpStatus,u.value.message??"Error while initializing the WaspHlsPlayer");o=!1,s(g)}break;case"seek":J(u,this.__contentMetadata__,this.videoElement);break;case"flush":K(u,this.__contentMetadata__,this.videoElement);break;case"upd-pbr":Z(u,this.__contentMetadata__,this.videoElement);break;case"attach-ms":Y(u,this.__contentMetadata__,this.videoElement),this.__startListeningToLoadedEvent__();break;case"create-ms":ee(u,this.__contentMetadata__,this.videoElement,d),this.__startListeningToLoadedEvent__();break;case"upd-ms-dur":re(u,this.__contentMetadata__,d);break;case"clear-ms":te(u,this.__contentMetadata__,this.videoElement);break;case"creat-sb":ne(u,this.__contentMetadata__,d);break;case"push-sb":ae(u,this.__contentMetadata__,d);break;case"rem-sb":oe(u,this.__contentMetadata__,d);break;case"start-obs":ie(u,this.__contentMetadata__,this.videoElement,d);break;case"stop-obs":se(u,this.__contentMetadata__);break;case"eos":ue(u,this.__contentMetadata__,d);break;case"media-off-upd":de(u,this.__contentMetadata__);break;case"m-playlist":ge(u,this.__contentMetadata__)&&(this.trigger("variantListUpdate",this.getVariantList()),this.trigger("audioTrackListUpdate",this.getAudioTrackList()));break;case"track-upd":be(u,this.__contentMetadata__)&&u.value.mediaType===w.Audio&&this.trigger("audioTrackUpdate",this.getAudioTrack());break;case"variant-upd":he(u,this.__contentMetadata__)&&this.trigger("variantUpdate",this.getCurrentVariant());break;case"variant-lck-upd":ye(u,this.__contentMetadata__)&&this.trigger("variantLockUpdate",this.getLockedVariant());break;case"err":{let g=fe(u,this.__contentMetadata__);g!==null&&(i.error("API: sending fatal error",g),this.trigger("error",g),this.trigger("playerStateChange","Error"));break}case"warn":{let g=_e(u,this.__contentMetadata__);g!==null&&this.trigger("warning",g);break}case"time-upd":me(u,this.__contentMetadata__);break;case"ctnt-stop":Me(u,this.__contentMetadata__)&&(this.__contentMetadata__=null,this.trigger("playerStateChange","Stopped"));break;case"rebuf-start":ce(u,this.__contentMetadata__,this.videoElement)&&this.trigger("rebufferingStarted",null);break;case"rebuf-end":le(u,this.__contentMetadata__,this.videoElement)&&this.trigger("rebufferingEnded",null);break;case"are-types-supp":ve(u,d);break;default:R(u)}},d.onerror=f=>{let u=f.error instanceof Error?f.error:"Unknown Error";i.error("API: Worker Error encountered",u),o&&s(f.error),this.dispose()};function p(f){c(d,{type:"upd-log",value:f})}}__startListeningToLoadedEvent__(){let r=this.__contentMetadata__;r!==null&&r.loadingAborter!==void 0&&$(this.videoElement,r.loadingAborter.signal).then(()=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0),this.trigger("playerStateChange","Loaded")},n=>{this.__contentMetadata__!==null&&(this.__contentMetadata__.loadingAborter=void 0);let a=n instanceof Error?n:"Unknown reason";i.info("Could not load content:",a)})}};var kn=V;})();
