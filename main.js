(()=>{function C(){let a="",e=-1;return function(){return e++,e>=Number.MAX_SAFE_INTEGER&&(a+="0",e=0),a+String(e)}}var M=class{constructor(e){this._sourceBuffer=e,this._queue=[],this._pendingTask=null;let r=setInterval(()=>{this._flush()},2e3),n=this._onPendingTaskError.bind(this),s=()=>{this._flush()};e.addEventListener("error",n),e.addEventListener("updateend",s),this._dispose=[()=>{clearInterval(r),e.removeEventListener("error",n),e.removeEventListener("updateend",s)}]}push(e){return console.debug("QSB: receiving order to push data to the SourceBuffer"),this._addToQueue({type:0,value:e})}removeBuffer(e,r){return console.debug("QSB: receiving order to remove data from the SourceBuffer",e,r),this._addToQueue({type:1,value:{start:e,end:r}})}getBufferedRanges(){return this._sourceBuffer.buffered}dispose(){for(this._dispose.forEach(e=>e()),this._pendingTask!==null&&(this._pendingTask.reject(new Error("QueuedSourceBuffer Cancelled")),this._pendingTask=null);this._queue.length>0;){let e=this._queue.shift();e!==void 0&&e.reject(new Error("QueuedSourceBuffer Cancelled"))}}_onPendingTaskError(e){let r=e instanceof Error?e:new Error("An unknown error occured when doing operations on the SourceBuffer");this._pendingTask!=null&&this._pendingTask.reject(r)}_addToQueue(e){return new Promise((r,n)=>{let s=this._queue.length===0&&this._pendingTask===null,u={resolve:r,reject:n,...e};this._queue.push(u),s&&this._flush()})}_flush(){if(!this._sourceBuffer.updating){if(this._pendingTask!==null){let e=this._pendingTask,{resolve:r}=e;return this._pendingTask=null,r(),this._flush()}else{let e=this._queue.shift();if(e===void 0)return;this._pendingTask=e}try{switch(this._pendingTask.type){case 0:let e=this._pendingTask.value;if(e===void 0){this._flush();return}console.debug("QSB: pushing data"),this._sourceBuffer.appendBuffer(e);break;case 1:let{start:r,end:n}=this._pendingTask.value;console.debug("QSB: removing data from SourceBuffer",r,n),this._sourceBuffer.remove(r,n);break;default:O(this._pendingTask)}}catch(e){this._onPendingTaskError(e)}}}};function O(a){throw new Error("Unreachable path taken")}var j=new TextDecoder("utf-8",{ignoreBOM:!0,fatal:!0});j.decode();var R=new Uint8Array;var z=new Int32Array;var T=new TextEncoder("utf-8"),Q=typeof T.encodeInto=="function"?function(a,e){return T.encodeInto(a,e)}:function(a,e){let r=T.encode(a);return e.set(r),{read:a.length,written:r.length}};var q=new Float64Array;var F=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),D=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),H=Object.freeze({UnknownError:0,0:"UnknownError",NoContentLoaded:1,1:"NoContentLoaded"}),V=Object.freeze({SourceBufferNotFound:0,0:"SourceBufferNotFound",UnknownError:1,1:"UnknownError"}),G=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",UnknownError:1,1:"UnknownError"}),X=Object.freeze({NoMediaSourceAttached:0,0:"NoMediaSourceAttached",MediaSourceIsClosed:1,1:"MediaSourceIsClosed",QuotaExceededError:2,2:"QuotaExceededError",TypeNotSupportedError:3,3:"TypeNotSupportedError",EmptyMimeType:4,4:"EmptyMimeType",UnknownError:5,5:"UnknownError"}),$=Object.freeze({NoResource:0,0:"NoResource",NoSourceBuffer:1,1:"NoSourceBuffer",TransmuxerError:2,2:"TransmuxerError",UnknownError:3,3:"UnknownError"}),J=Object.freeze({Init:0,0:"Init",Seeked:1,1:"Seeked",Seeking:2,2:"Seeking",Ended:3,3:"Ended",ReadyStateChanged:4,4:"ReadyStateChanged",RegularInterval:5,5:"RegularInterval",Error:6,6:"Error"}),K=Object.freeze({MediaPlaylistRefresh:0,0:"MediaPlaylistRefresh"}),Y=Object.freeze({Error:0,0:"Error",Warn:1,1:"Warn",Info:2,2:"Info",Debug:3,3:"Debug"}),Z=Object.freeze({Audio:0,0:"Audio",Video:1,1:"Video"}),w=Object.freeze({Closed:0,0:"Closed",Ended:1,1:"Ended",Open:2,2:"Open"}),l=Object.freeze({Init:0,0:"Init",Seeking:1,1:"Seeking",Seeked:2,2:"Seeked",RegularInterval:3,3:"RegularInterval",LoadedData:4,4:"LoadedData",LoadedMetadata:5,5:"LoadedMetadata",CanPlay:6,6:"CanPlay",CanPlayThrough:7,7:"CanPlayThrough",Ended:8,8:"Ended",Pause:9,9:"Pause",Play:10,10:"Play",RateChange:11,11:"RateChange",Stalled:12,12:"Stalled"});var h=class extends Error{constructor(r,n,s){super();Object.setPrototypeOf(this,h.prototype),this.name="InitializationError",this.code=r,this.wasmHttpStatus=n,this.message=s}};var S=class{constructor(){this._listeners={}}addEventListener(e,r){let n=this._listeners[e];Array.isArray(n)?n.push(r):this._listeners[e]=[r]}removeEventListener(e,r){if(e===void 0){this._listeners={};return}let n=this._listeners[e];if(!Array.isArray(n))return;if(r===void 0){delete this._listeners[e];return}let s=n.indexOf(r);s!==-1&&n.splice(s,1),n.length===0&&delete this._listeners[e]}trigger(e,r){let n=this._listeners[e];!Array.isArray(n)||n.slice().forEach(s=>{try{s(r)}catch(u){console.error("EventEmitter: listener error",u instanceof Error?u:null)}})}};var B=[["seeking",l.Seeking],["seeked",l.Seeked],["loadedmetadata",l.LoadedMetadata],["loadeddata",l.LoadedData],["canplay",l.CanPlay],["canplaythrough",l.CanPlayThrough],["ended",l.Ended],["pause",l.Pause],["play",l.Play],["ratechange",l.RateChange],["stalled",l.Stalled]];function x(a,e,r){let n=!1,s,u=B.map(([i,_])=>{a.addEventListener(i,t);function t(){p(_)}return()=>a.removeEventListener(i,t)});return Promise.resolve().then(()=>p(l.Init)),()=>{n||(n=!0,u.forEach(i=>i()),u.length=0,s!==void 0&&(clearTimeout(s),s=void 0))};function p(i){if(n)return;s!==void 0&&(clearTimeout(s),s=void 0);let _=new Float64Array(a.buffered.length*2);for(let d=0;d<a.buffered.length;d++){let b=d*2;_[b]=a.buffered.start(d),_[b+1]=a.buffered.end(d)}let{currentTime:t,readyState:g,paused:o,seeking:f}=a;r({mediaSourceId:e,reason:i,currentTime:t,readyState:g,buffered:_,paused:o,seeking:f}),s=window.setTimeout(()=>{if(n){s=void 0;return}p(l.RegularInterval)},1e3)}}function c(a,e,r){console.debug("--> sending to worker:",e.type),r===void 0?a.postMessage(e):a.postMessage(e,r)}var A=C(),E=class extends S{constructor(r){super();this.videoElement=r,this.initializationStatus=k.Uninitialized,this._worker=null,this._currentContentMetadata=null}initialize(r){try{this.initializationStatus=k.Initializing;let{wasmUrl:n,workerUrl:s}=r,u=P,p=P,i=new Promise((_,t)=>{u=_,p=t});return this._startWorker(s,n,u,p),i}catch(n){return this.initializationStatus=k.Errored,Promise.reject(n)}}loadContent(r){if(this._worker===null)throw new Error("The Player is not initialized or disposed.");let n=A();this._currentContentMetadata={contentId:n,mediaSourceId:null,mediaSource:null,disposeMediaSource:null,sourceBuffers:[],stopPlaybackObservations:null,mediaOffset:void 0,minimumPosition:void 0,maximumPosition:void 0},c(this._worker,{type:"load",value:{contentId:n,url:r}})}getPosition(){return this._currentContentMetadata===null?0:this.videoElement.currentTime-(this._currentContentMetadata.mediaOffset??0)}seek(r){if(this._currentContentMetadata===null)throw new Error("Cannot seek: no content loaded.");this.videoElement.currentTime=r+(this._currentContentMetadata.mediaOffset??0)}getMediaOffset(){return this._currentContentMetadata?.mediaOffset??void 0}setVolume(r){this.videoElement.volume=r}mute(){this.videoElement.muted=!0}unmute(){this.videoElement.muted=!1}isPaused(){return this.videoElement.paused}pause(){this.videoElement.pause()}resume(){this.videoElement.play().catch(()=>{})}stop(){if(this._worker===null)throw new Error("The Player is not initialized or disposed.");this._currentContentMetadata!==null&&this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),this._currentContentMetadata!==null&&c(this._worker,{type:"stop",value:{contentId:this._currentContentMetadata.contentId}})}setSpeed(r){this.videoElement.playbackRate=r}getSpeed(){return this.videoElement.playbackRate}getMinimumPosition(){return this._currentContentMetadata?.minimumPosition}getMaximumPosition(){return this._currentContentMetadata?.maximumPosition}dispose(){this._worker!==null&&(this._currentContentMetadata!==null&&this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),c(this._worker,{type:"dispose",value:null}),this._worker=null)}_startWorker(r,n,s,u){let p=!0,i=new Worker(r);this._worker=i,c(i,{type:"init",value:{hasWorkerMse:typeof MediaSource=="function"&&MediaSource.canConstructInDedicatedWorker===!0,wasmUrl:n}}),i.onmessage=_=>{let{data:t}=_;if(typeof t!="object"||t===null||typeof t.type!="string"){console.error("unexpected Worker message");return}switch(t.type){case"initialized":this.initializationStatus=k.Initialized,p=!1,s();break;case"initialization-error":if(p){let o=new h(t.value.code,t.value.wasmHttpStatus,t.value.message??"Error while initializing the WaspHlsPlayer");p=!1,u(o)}break;case"seek":if(this._currentContentMetadata===null||this._currentContentMetadata.mediaSourceId!==t.value.mediaSourceId){console.info("API: Ignoring seek due to wrong `mediaSourceId`");return}try{this.videoElement.currentTime=t.value.position}catch(o){console.error("Unexpected error while seeking:",o)}break;case"attach-media-source":if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==t.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}if(this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),t.value.handle!==void 0)this.videoElement.srcObject=t.value.handle;else if(t.value.src!==void 0)this.videoElement.src=t.value.src;else throw new Error('Unexpected "attach-media-source" message: missing source');this._currentContentMetadata.mediaSourceId=t.value.mediaSourceId,this._currentContentMetadata.mediaSource=null,this._currentContentMetadata.disposeMediaSource=()=>{t.value.src!==void 0&&URL.revokeObjectURL(t.value.src)},this._currentContentMetadata.sourceBuffers=[],this._currentContentMetadata.stopPlaybackObservations=null;break;case"create-media-source":{if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==t.value.contentId){console.info("API: Ignoring MediaSource attachment due to wrong `contentId`");return}let{mediaSourceId:o}=t.value,f;try{f=new MediaSource}catch(b){let{name:m,message:y}=v(b,"Unknown error when creating the MediaSource");c(i,{type:"create-media-source-error",value:{mediaSourceId:o,message:y,name:m}});return}let d=W(i,f,this.videoElement,o);this._currentContentMetadata.mediaSourceId=t.value.mediaSourceId,this._currentContentMetadata.mediaSource=f,this._currentContentMetadata.disposeMediaSource=d,this._currentContentMetadata.sourceBuffers=[],this._currentContentMetadata.stopPlaybackObservations=null;break}case"update-media-source-duration":{let{mediaSourceId:o}=t.value;if(this._currentContentMetadata?.mediaSourceId!==o||this._currentContentMetadata.mediaSource===null)return;try{this._currentContentMetadata.mediaSource.duration=t.value.duration}catch(f){let{name:d,message:b}=v(f,"Unknown error when updating the MediaSource's duration");c(i,{type:"update-media-source-duration-error",value:{mediaSourceId:o,message:b,name:d}});return}break}case"clear-media-source":{if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;try{this._currentContentMetadata.disposeMediaSource?.(),L(this.videoElement)}catch(o){console.warn("API: Error when clearing current MediaSource:",o)}break}case"create-source-buffer":{if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;if(this._currentContentMetadata.mediaSource===null){c(i,{type:"create-source-buffer-error",value:{mediaSourceId:t.value.mediaSourceId,sourceBufferId:t.value.sourceBufferId,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{let o=this._currentContentMetadata.mediaSource.addSourceBuffer(t.value.contentType),f=new M(o);this._currentContentMetadata.sourceBuffers.push({sourceBufferId:t.value.sourceBufferId,queuedSourceBuffer:f})}catch(o){let{name:f,message:d}=v(o,"Unknown error when adding the SourceBuffer to the MediaSource");c(i,{type:"create-source-buffer-error",value:{mediaSourceId:t.value.mediaSourceId,sourceBufferId:t.value.sourceBufferId,code:1,message:d,name:f}})}break}case"append-buffer":{let b=function(m){let{name:y,message:I}=v(m,"Unknown error when appending data to the SourceBuffer");c(i,{type:"source-buffer-error",value:{sourceBufferId:d,message:I,name:y}})};if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;let o=this._currentContentMetadata.sourceBuffers.find(({sourceBufferId:m})=>m===t.value.sourceBufferId);if(o===void 0)return;let{mediaSourceId:f,sourceBufferId:d}=t.value;try{o.queuedSourceBuffer.push(t.value.data).then(()=>{c(i,{type:"source-buffer-updated",value:{mediaSourceId:f,sourceBufferId:d}})}).catch(b)}catch(m){b(m)}break}case"remove-buffer":{let b=function(m){let{name:y,message:I}=v(m,"Unknown error when removing data to the SourceBuffer");c(i,{type:"source-buffer-error",value:{sourceBufferId:d,message:I,name:y}})};if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;let o=this._currentContentMetadata.sourceBuffers.find(({sourceBufferId:m})=>m===t.value.sourceBufferId);if(o===void 0)return;let{mediaSourceId:f,sourceBufferId:d}=t.value;try{o.queuedSourceBuffer.removeBuffer(t.value.start,t.value.end).then(()=>{c(i,{type:"source-buffer-updated",value:{mediaSourceId:f,sourceBufferId:d}})}).catch(b)}catch(m){b(m)}break}case"start-playback-observation":{if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null),this._currentContentMetadata.stopPlaybackObservations=x(this.videoElement,t.value.mediaSourceId,o=>c(i,{type:"observation",value:o}));break}case"stop-playback-observation":{if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;this._currentContentMetadata.stopPlaybackObservations!==null&&(this._currentContentMetadata.stopPlaybackObservations(),this._currentContentMetadata.stopPlaybackObservations=null);break}case"end-of-stream":if(this._currentContentMetadata?.mediaSourceId!==t.value.mediaSourceId)return;let{mediaSourceId:g}=t.value;if(this._currentContentMetadata.mediaSource===null){c(i,{type:"end-of-stream-error",value:{mediaSourceId:g,code:0,message:"No MediaSource created on the main thread.",name:void 0}});return}try{this._currentContentMetadata.mediaSource.endOfStream()}catch(o){let{name:f,message:d}=v(o,"Unknown error when calling MediaSource.endOfStream()");c(i,{type:"end-of-stream-error",value:{mediaSourceId:g,code:1,message:d,name:f}})}break;case"media-offset-update":if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==t.value.contentId){console.info("API: Ignoring media offset update due to wrong `contentId`");return}this._currentContentMetadata.mediaOffset=t.value.offset;break;case"content-warning":if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==t.value.contentId){console.info("API: Ignoring warning due to wrong `contentId`");return}console.warn("Warning received",t.value.code);break;case"content-info-update":if(this._currentContentMetadata===null||this._currentContentMetadata.contentId!==t.value.contentId){console.info("API: Ignoring warning due to wrong `contentId`");return}this._currentContentMetadata.minimumPosition=t.value.minimumPosition,this._currentContentMetadata.maximumPosition=t.value.minimumPosition;break}},i.onerror=_=>{console.error("API: Worker Error encountered",_.error),p&&u(_.error)}}};function W(a,e,r,n){e.addEventListener("sourceclose",i),e.addEventListener("sourceended",u),e.addEventListener("sourceopen",p);let s=URL.createObjectURL(e);r.src=s;function u(){c(a,{type:"media-source-state-changed",value:{mediaSourceId:n,state:w.Ended}})}function p(){c(a,{type:"media-source-state-changed",value:{mediaSourceId:n,state:w.Open}})}function i(){c(a,{type:"media-source-state-changed",value:{mediaSourceId:n,state:w.Closed}})}return()=>{if(e.removeEventListener("sourceclose",i),e.removeEventListener("sourceended",u),e.removeEventListener("sourceopen",p),URL.revokeObjectURL(s),e.readyState!=="closed"){let{readyState:_,sourceBuffers:t}=e;for(let g=t.length-1;g>=0;g--){let o=t[g];if(!o.updating)try{_==="open"&&o.abort(),e.removeSourceBuffer(o)}catch{}}}r.src="",r.removeAttribute("src")}}var k=(u=>(u.Uninitialized="Uninitialized",u.Initializing="Initializing",u.Initialized="Initialized",u.Errored="errorred",u.Disposed="disposed",u))(k||{});function P(){}function L(a){let{textTracks:e}=a;if(e!=null){for(let r=0;r<e.length;r++)e[r].mode="disabled";if(a.hasChildNodes()){let{childNodes:r}=a;for(let n=r.length-1;n>=0;n--)if(r[n].nodeName==="track")try{a.removeChild(r[n])}catch{}}}a.src="",a.removeAttribute("src")}function v(a,e){return a instanceof Error?{message:a.message,name:a.name}:{message:e,name:void 0}}var Se=E;})();
